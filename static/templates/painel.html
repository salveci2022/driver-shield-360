<!doctype html><html lang="pt-BR"><head>
<link rel="manifest" href="/static/manifest.json">
  <link rel="icon" type="image/png" href="/static/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#0a0014">
<meta charset="utf-8"><title>Pessoa de ConfianÃ§a - Driver Shield 360</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"></head><body><div class="container"><div class="card"><div class="header"><div class="title">ğŸ§‘â€ğŸ¤â€ğŸ§‘ Painel da Pessoa de ConfianÃ§a</div><div class="row"><button class="btn small" onclick="goFull()">â›¶ Tela cheia</button><button class="btn small" onclick="location.reload()">Reiniciar</button><button class="btn small danger" onclick="limpar()">Limpar</button><button class="btn small danger" onclick="toggleSirene()">ğŸ”Š Sirene</button><a class="btn small" href="{{ url_for('pessoa_sair') }}">Sair</a></div></div><div class="notice">Este painel Ã© <b>aberto</b> (sem senha). Para o som da sirene funcionar no celular, toque no botÃ£o â€œSireneâ€ uma vez para liberar o Ã¡udio.</div><hr><div class="grid"><div class="card"><div class="title" style="font-size:18px">Ãšltimo alerta</div><div id="ultimo" class="notice">Aguardando alertaâ€¦</div><hr><div class="title" style="font-size:18px">Mapa</div><iframe id="mapa" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div><div class="card"><div class="title" style="font-size:18px">Lista de alertas</div><div id="lista" class="notice">â€”</div></div></div><audio id="sireneAudio" preload="auto" loop><source src="{{ url_for('static', filename='sirene.mp3') }}" type="audio/mpeg"></audio></div></div><script>
function goFull(){const el=document.documentElement;if(el.requestFullscreen)el.requestFullscreen();}
let sireneOn=false;function toggleSirene(){const audio=document.getElementById('sireneAudio');if(!sireneOn){audio.volume=1.0;audio.play().then(()=>{sireneOn=true;}).catch(()=>{alert('O Chrome bloqueou o Ã¡udio. Clique novamente no botÃ£o Sirene.');});}else{audio.pause();audio.currentTime=0;sireneOn=false;}}
let lastCount=0;
function setMapa(lat,lng){const iframe=document.getElementById('mapa');if(!lat||!lng){iframe.srcdoc="<div style='padding:14px;color:#cdb7e6;font-family:system-ui'>Sem localizaÃ§Ã£o neste alerta.</div>";return;}iframe.src=`https://www.google.com/maps?q=${lat},${lng}&z=16&output=embed`;}
function renderAlert(a){const el=document.getElementById('ultimo');const lat=a.lat,lng=a.lng;el.innerHTML=`<div><b>HorÃ¡rio:</b> ${a.ts}</div><div><b>Motorista:</b> ${a.motorista}</div><div><b>OcorrÃªncia:</b> ${a.ocorrencia}</div><div><b>Local:</b> ${lat&&lng?lat+", "+lng:"â€”"}</div>`;setMapa(lat,lng);} 
function renderLista(alerts){const box=document.getElementById('lista');if(!alerts.length){box.textContent='Nenhum alerta ainda.';return;}box.innerHTML=alerts.slice().reverse().map(a=>`<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.10)"><div><b>${a.ts}</b> â€” ${a.ocorrencia}</div><div style="color:#cdb7e6">Motorista: ${a.motorista}</div></div>`).join('');}
async function poll(){const res=await fetch('/api/alerts',{cache:'no-store'});const alerts=await res.json();renderLista(alerts);if(alerts.length)renderAlert(alerts[alerts.length-1]);lastCount=alerts.length;}
poll();setInterval(poll,3000);
async function limpar(){if(!confirm('Limpar todos os alertas?'))return;const res=await fetch('/api/clear_alerts',{method:'POST'});const j=await res.json();if(j.ok){lastCount=0;alert('Alertas limpos!');location.reload();}else{alert('Falha ao limpar.');}}
</script></body></html>
