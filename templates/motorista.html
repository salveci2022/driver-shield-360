<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Driver Shield 360</title>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#071018">
  <link rel="icon" href="/static/driver_shield_360.png">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"><img src="/static/driver_shield_360.png" alt="Logo"></div>
        <div>
          <h1 class="h1">Driver Shield 360</h1>
          <div class="subtitle">Sistema de apoio √† seguran√ßa preventiva para motoristas de aplicativo.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <span class="badge">‚úÖ PWA instal√°vel (atalho com logo)</span>
        <span class="badge">üîí LGPD + aceite obrigat√≥rio</span>
        <span class="badge">‚ö†Ô∏è N√£o substitui 190</span>
      </div>

      <div class="field">
        <label for="driverName">Seu nome (ou apelido)</label>
        <input id="driverName" placeholder="Ex.: Jo√£o Uber" autocomplete="name">
      </div>

      <div class="field">
        <label>Tipo de ocorr√™ncia</label>
        <div class="notice">Toque em uma op√ß√£o antes de acionar o bot√£o de p√¢nico.</div>
        <div class="pills" id="pills"></div>
        <div class="notice" id="selectedInfo">Ocorr√™ncia selecionada: <b>nenhuma</b></div>
      </div>

      <div class="hr"></div>

      <div class="checkbox">
        <input type="checkbox" id="acceptTerms">
        <div>
          Declaro que li e concordo com os <a href="/termos" target="_blank" rel="noopener">Termos de Uso e Pol√≠tica de Privacidade</a>.
          <div class="small">O sistema depende de internet, do funcionamento do celular e permiss√µes do navegador. Em risco real, ligue 190.</div>
        </div>
      </div>

      <div class="field">
        <button class="btn btn-primary big-panic" id="panicBtn" disabled>üö® BOT√ÉO DE P√ÇNICO ‚Äî TOQUE PARA ENVIAR ALERTA</button>
        <div class="small" id="panicHint">Para habilitar: selecione ocorr√™ncia + preencha nome + aceite os termos.</div>
      </div>

      <div class="hr"></div>

      <div class="field">
        <label>Pessoas de confian√ßa cadastradas</label>
        <ul class="list" id="contactsList"><li>Carregando‚Ä¶</li></ul>
        <div class="small">Cadastre/edite em <a href="/cadastro">/cadastro</a>.</div>
      </div>

      <div class="footerbar">
        <a class="btn btn-secondary" href="/relatorio">Relat√≥rio de ocorr√™ncias</a>
        <button class="btn btn-secondary" id="reloadBtn">Reiniciar painel</button>
        <button class="btn btn-danger" id="clearBtn">Limpar alertas</button>
      </div>
    </div>
  </div>

<script>
const OCC = [
  "Abordagem suspeita",
  "Tentativa de assalto",
  "Passageiro agressivo",
  "Conflito com outro ve√≠culo",
  "Emerg√™ncia de sa√∫de",
  "Outro risco"
];

let selectedOcc = null;

function $(id){ return document.getElementById(id); }

function renderPills(){
  const wrap = $("pills");
  wrap.innerHTML = "";
  OCC.forEach((name)=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "pill";
    b.textContent = name;
    b.onclick = ()=>{
      selectedOcc = name;
      [...wrap.querySelectorAll(".pill")].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $("selectedInfo").innerHTML = 'Ocorr√™ncia selecionada: <b>'+name+'</b>';
      updateButtonState();
    };
    wrap.appendChild(b);
  });
}

function updateButtonState(){
  const ok = $("acceptTerms").checked && ($("driverName").value||"").trim().length >= 2 && !!selectedOcc;
  $("panicBtn").disabled = !ok;

  // Mant√©m o bot√£o redondo (FAB) sincronizado com as regras de aceite/nome/ocorr√™ncia
  const fab = document.getElementById("panicFab");
  if(fab){
    fab.setAttribute("aria-disabled", String(!ok));
    fab.style.pointerEvents = ok ? "auto" : "none";
    fab.style.opacity = ok ? "1" : ".35";
  }
}

async function loadContacts(){
  const ul = $("contactsList");
  ul.innerHTML = "<li>Carregando‚Ä¶</li>";
  try{
    const r = await fetch("/api/contacts");
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || "Falha ao carregar");
    if(!data.contacts.length){
      ul.innerHTML = "<li>Nenhum contato cadastrado ainda.</li>";
      return;
    }
    ul.innerHTML = "";
    data.contacts.forEach(c=>{
      const li = document.createElement("li");
      li.textContent = c.name + " ‚Äî " + c.phone;
      ul.appendChild(li);
    });
  }catch(e){
    ul.innerHTML = "<li>Erro ao carregar contatos.</li>";
  }
}

async function acceptTerms(){
  try{
    await fetch("/api/accept-terms", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({accepted:true})});
  }catch(e){}
}

async function getLocation(){
  return await new Promise((resolve)=>{
    if(!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve({lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy}),
      ()=>resolve(null),
      {enableHighAccuracy:true, timeout:8000, maximumAge:0}
    );
  });
}

async function sendPanic(){
  const payload = {
    driver_name: $("driverName").value.trim(),
    occurrence: selectedOcc,
    accepted_terms: $("acceptTerms").checked
  };
  const loc = await getLocation();
  if(loc) payload.location = loc;

  const btn = $("panicBtn");
  btn.disabled = true;
  btn.textContent = "Enviando alerta‚Ä¶";

  try{
    const r = await fetch("/api/panic", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || "Falha no envio");

    btn.textContent = "‚úÖ Alerta registrado!";
    $("panicHint").textContent = "Alerta registrado e salvo no relat√≥rio. Em risco real, ligue 190.";
    setTimeout(()=>{ btn.textContent = "üö® BOT√ÉO DE P√ÇNICO ‚Äî TOQUE PARA ENVIAR ALERTA"; updateButtonState(); }, 2200);
  }catch(e){
    btn.textContent = "‚ùå Erro ao enviar. Tente de novo.";
    setTimeout(()=>{ btn.textContent = "üö® BOT√ÉO DE P√ÇNICO ‚Äî TOQUE PARA ENVIAR ALERTA"; updateButtonState(); }, 2400);
  }
}

async function clearAlerts(){
  if(!confirm("Limpar todos os alertas registrados?")) return;
  try{
    const r = await fetch("/api/clear_alerts", {method:"POST"});
    const data = await r.json();
    if(!data.ok) throw new Error("Falha");
    alert("Alertas limpos.");
  }catch(e){
    alert("Erro ao limpar.");
  }
}

$("acceptTerms").addEventListener("change", ()=>{ updateButtonState(); if($("acceptTerms").checked) acceptTerms(); });
$("driverName").addEventListener("input", updateButtonState);
$("panicBtn").addEventListener("click", sendPanic);
const panicFab=document.getElementById("panicFab");
if(panicFab){ panicFab.addEventListener("click", ()=> $("panicBtn").click()); }

$("reloadBtn").addEventListener("click", ()=>location.reload());
$("clearBtn").addEventListener("click", clearAlerts);

renderPills();
loadContacts();
updateButtonState();

// Service Worker (PWA)
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/static/sw.js").catch(()=>{});
}
</script>

<button id="panicFab" class="panic-fab" type="button" aria-label="Bot√£o de p√¢nico" aria-disabled="true">
  <span class="fab-icon">üö®</span>
  <span class="fab-label">P√¢nico</span>
</button>

</body>
</html>
