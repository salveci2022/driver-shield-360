<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Driver Shield 360 â€” Motorista</title>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#071018">
  <link rel="icon" href="/static/icon-192.png">
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <link rel="stylesheet" href="/static/style.css?v=12">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"><img src="/static/icon-192.png" alt="Logo"></div>
      <div>
        <h1 class="h1">Driver Shield 360</h1>
        <div class="subtitle">Painel do motorista (PWA instalÃ¡vel)</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="badges">
      <span class="badge">ğŸ›¡ï¸ Apoio preventivo</span>
      <span class="badge">ğŸ” LGPD + aceite</span>
      <span class="badge">âš ï¸ NÃ£o substitui 190</span>
    </div>

    <div class="field">
      <label>Seu nome (ou apelido)</label>
      <input id="nome" placeholder="Ex: JoÃ£o Uber">
      <div class="small">Sem nÃºmero de celular. Apenas identificaÃ§Ã£o no alerta.</div>
    </div>

    <div class="field">
      <label>Tipo de ocorrÃªncia</label>
      <div class="pills" id="ocorrencias">
        <div class="pill">Abordagem suspeita</div>
        <div class="pill">Tentativa de assalto</div>
        <div class="pill">Passageiro agressivo</div>
        <div class="pill">EmergÃªncia de saÃºde</div>
        <div class="pill">Outro risco</div>
      </div>
      <div class="notice">OcorrÃªncia selecionada: <b id="sel">nenhuma</b></div>
    </div>

    <div class="checkbox">
      <input type="checkbox" id="aceite">
      <label>
        Li e concordo com os <a href="/termos" target="_blank">Termos de Uso e LGPD</a>.
        <div class="small">A localizaÃ§Ã£o Ã© enviada somente se vocÃª autorizar e se houver internet/GPS no momento do alerta.</div>
      </label>
    </div>

    <div class="panic-area">
      <button id="panicBtn" class="panic-button" disabled>ğŸš¨</button>
      <div class="panic-label">BOTÃƒO DE PÃ‚NICO</div>
      <div class="panic-sub">Toque para enviar alerta</div>
    </div>

    <div class="hr"></div>

    <div class="btnbar">
      <button class="btn btn-secondary" onclick="location.href='/cadastro'">ğŸ‘¥ Cadastrar pessoa de confianÃ§a</button>
      <button class="btn" onclick="location.href='/relatorio'">ğŸ“„ RelatÃ³rio</button>
    </div>

    <div class="notice">Em risco real, ligue imediatamente <b>190</b>. Este sistema Ã© apoio complementar.</div>
  </div>
</div>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/static/sw.js").catch(()=>{});
  }

  let ocorrencia = null;
  function validar(){
    const nome = document.getElementById("nome").value.trim();
    const aceite = document.getElementById("aceite").checked;
    document.getElementById("panicBtn").disabled = !(nome && ocorrencia && aceite);
  }

  document.querySelectorAll(".pill").forEach(p=>{
    p.addEventListener("click", ()=>{
      document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      ocorrencia = p.textContent.trim();
      document.getElementById("sel").textContent = ocorrencia;
      validar();
    });
  });

  document.getElementById("nome").addEventListener("input", validar);
  document.getElementById("aceite").addEventListener("change", validar);

  async function postAlert(payload){
    const r = await fetch("/api/panic", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    return r.ok;
  }

  async function enviarAlerta(){
    const nome = document.getElementById("nome").value.trim();
    const payload = { driver_name: nome, occurrence: ocorrencia };

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        payload.location = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        };
        await postAlert(payload);
        alert("ğŸš¨ Alerta enviado.");
      }, async ()=>{
        await postAlert(payload);
        alert("ğŸš¨ Alerta enviado (sem localizaÃ§Ã£o).");
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    } else {
      await postAlert(payload);
      alert("ğŸš¨ Alerta enviado.");
    }
  }

  document.getElementById("panicBtn").addEventListener("click", enviarAlerta);
</script>
</body>
</html>
