<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motorista - Driver Shield 360</title>

  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#12001f" />

  <link rel="icon" href="/static/driver_shield_360.png" />
  <link rel="apple-touch-icon" href="/static/driver_shield_360.png" />
  <link rel="stylesheet" href="/static/style.css" />

  <style>
    /* Ajustes finos (sem quebrar o style global) */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:42px;height:42px;border-radius:14px;box-shadow:0 12px 35px rgba(0,0,0,.35)}
    .brand h1{margin:0;font-size:22px;letter-spacing:.2px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}

    .occ-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (min-width: 900px){.occ-grid{grid-template-columns:repeat(3,minmax(0,1fr));}}

    .occ-btn{appearance:none;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:#f3e9ff;
             padding:12px 12px;border-radius:16px;cursor:pointer;font-weight:700;letter-spacing:.2px;
             transition:.15s transform, .15s filter, .15s background;}
    .occ-btn:hover{transform:translateY(-1px);filter:brightness(1.08)}
    .occ-btn.active{background:linear-gradient(135deg, rgba(164,92,255,.55), rgba(255,79,200,.35));border-color:rgba(255,255,255,.18)}

    .contacts ul{margin:0;padding-left:18px}
    .contacts li{margin:8px 0}

    .sos-note{margin:12px 0 0;opacity:.9}
  </style>
</head>

<body>
  <div class="shell">
    <div class="card wide">
      <div class="topbar">
        <div class="brand">
          <img src="/static/driver_shield_360.png" alt="Driver Shield 360" />
          <h1>ðŸš– Painel do Motorista</h1>
        </div>
        <div class="btns">
          <button class="btn" id="btnFullscreen">â›¶ Tela cheia</button>
          <button class="btn" id="btnReload">Reiniciar</button>
          <button class="btn danger" id="btnClear">Limpar alertas</button>
          <button class="btn" id="btnExit">Sair</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Tipo de ocorrÃªncia</h2>
        <p class="muted">JÃ¡ vem prÃ©-selecionado para vocÃª apertar o SOS mais rÃ¡pido.</p>

        <div class="occ-grid" id="occGrid"></div>

        <div style="margin-top:14px">
          <label class="label" for="driverName">Seu nome (opcional)</label>
          <input class="input" id="driverName" type="text" placeholder="Ex.: JoÃ£o (Uber)" />
        </div>

        <div class="card inner contacts" style="margin-top:16px">
          <h3>Pessoas de confianÃ§a cadastradas</h3>
          {% if contacts and contacts|length > 0 %}
            <ul>
              {% for c in contacts %}
                <li><strong>{{ c.nome }}</strong> â€” {{ c.telefone }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">Nenhuma pessoa cadastrada ainda.</p>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <h2>BotÃ£o de PÃ¢nico</h2>

        <div class="sosWrap">
          <button class="sos" id="btnSOS">SOS</button>
        </div>

        <p class="sos-note">OcorrÃªncia selecionada: <strong id="occSelected">Abordagem suspeita</strong></p>

        <div class="divider"></div>

        <div>
          <h3>LocalizaÃ§Ã£o</h3>
          <p id="locText" class="muted">Permita o acesso Ã  localizaÃ§Ã£o no navegador/celular.</p>
        </div>

        <audio id="siren" preload="auto">
          <source src="/static/sirene.mp3" type="audio/mpeg" />
        </audio>

        <div class="divider"></div>
        <p class="muted" style="margin:0">Dica: instale como app (PWA) para ficar 1 toque na tela inicial.</p>
      </div>
    </div>
  </div>

  <script>
    // OcorrÃªncias (prÃ©-selecionadas)
    const OCCURRENCES = [
      'Abordagem suspeita',
      'Tentativa de assalto',
      'AmeaÃ§a / intimidaÃ§Ã£o',
      'Passageiro agressivo',
      'Seguimento / perseguiÃ§Ã£o',
      'EmergÃªncia mÃ©dica',
      'Outro'
    ];

    const occGrid = document.getElementById('occGrid');
    const occSelected = document.getElementById('occSelected');
    let currentOcc = OCCURRENCES[0];

    function renderOccButtons(){
      occGrid.innerHTML = '';
      OCCURRENCES.forEach((label, idx) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'occ-btn' + (idx===0 ? ' active' : '');
        b.textContent = label;
        b.addEventListener('click', () => {
          currentOcc = label;
          occSelected.textContent = label;
          [...occGrid.querySelectorAll('.occ-btn')].forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
        });
        occGrid.appendChild(b);
      });
      occSelected.textContent = currentOcc;
    }

    renderOccButtons();

    // Fullscreen
    document.getElementById('btnFullscreen').addEventListener('click', async () => {
      try{
        if (!document.fullscreenElement) {
          await document.documentElement.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      }catch(e){console.warn(e)}
    });

    document.getElementById('btnReload').addEventListener('click', () => location.reload());

    document.getElementById('btnExit').addEventListener('click', () => {
      // MantÃ©m este painel isolado: sai para o inÃ­cio
      window.location.href = '/';
    });

    document.getElementById('btnClear').addEventListener('click', async () => {
      try{
        await fetch('/api/clear_alerts', {method:'POST'});
        alert('Alertas limpos!');
      }catch(e){alert('NÃ£o foi possÃ­vel limpar agora.')}
    });

    // LocalizaÃ§Ã£o
    const locText = document.getElementById('locText');
    let lastLat = null, lastLng = null, lastAcc = null;

    function updateLocText(){
      if (lastLat===null || lastLng===null) {
        locText.textContent = 'Permita o acesso Ã  localizaÃ§Ã£o no navegador/celular.';
        return;
      }
      locText.textContent = `Lat: ${lastLat.toFixed(6)} | Lng: ${lastLng.toFixed(6)} (precisÃ£o: ~${Math.round(lastAcc||0)}m)`;
    }

    function startGeo(){
      if (!navigator.geolocation) {
        locText.textContent = 'GeolocalizaÃ§Ã£o nÃ£o suportada neste dispositivo.';
        return;
      }

      navigator.geolocation.watchPosition(
        (pos) => {
          lastLat = pos.coords.latitude;
          lastLng = pos.coords.longitude;
          lastAcc = pos.coords.accuracy;
          updateLocText();
        },
        (err) => {
          locText.textContent = 'Permita o acesso Ã  localizaÃ§Ã£o no navegador/celular.';
          console.warn(err);
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
      );
    }

    startGeo();

    // SOS
    const siren = document.getElementById('siren');
    const btnSOS = document.getElementById('btnSOS');

    async function playSiren(){
      try{
        siren.currentTime = 0;
        await siren.play();
      }catch(e){console.warn('autoplay bloqueado', e)}
    }

    btnSOS.addEventListener('click', async () => {
      btnSOS.disabled = true;
      btnSOS.classList.add('pulse');
      await playSiren();

      const driverName = (document.getElementById('driverName').value || '').trim();

      const payload = {
        occurrence: currentOcc,
        driver_name: driverName,
        lat: lastLat,
        lng: lastLng,
        accuracy: lastAcc
      };

      try{
        const res = await fetch('/api/alert', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data && data.ok) {
          alert('âœ… Alerta enviado para as pessoas de confianÃ§a!');
        } else {
          alert('âš ï¸ NÃ£o consegui enviar agora. Tente novamente.');
        }
      }catch(e){
        alert('âš ï¸ Falha de rede ao enviar alerta.');
      }finally{
        btnSOS.disabled = false;
        btnSOS.classList.remove('pulse');
      }
    });

    // Service worker (PWA)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
