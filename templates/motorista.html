<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Motorista | {{ app_name }}</title>
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <span style="font-size:20px">üöó</span>
        <div>
          <div style="font-size:20px">Painel do Motorista</div>
          <div class="small">Um toque para enviar alerta com ocorr√™ncia e localiza√ß√£o.</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" onclick="setFullScreen()">‚õ∂ Tela cheia</button>
        <button class="btn ghost" onclick="location.reload()">‚Üª Reiniciar</button>
        <button class="btn danger" onclick="clearLocal()">üßπ Limpar</button>
        <a class="btn" href="/">‚üµ Sair</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Configura√ß√£o r√°pida</h2>

        <div class="label">Tipo de ocorr√™ncia (pr√©-selecionado)</div>
        <select id="occ">
          <option value="Abordagem suspeita" selected>Abordagem suspeita</option>
          <option value="Tentativa de assalto">Tentativa de assalto</option>
          <option value="Amea√ßa / intimida√ß√£o">Amea√ßa / intimida√ß√£o</option>
          <option value="Passageiro agressivo">Passageiro agressivo</option>
          <option value="Seguimento / persegui√ß√£o">Seguimento / persegui√ß√£o</option>
          <option value="Emerg√™ncia m√©dica">Emerg√™ncia m√©dica</option>
          <option value="Outro">Outro</option>
        </select>

        <div class="label">Seu nome (opcional)</div>
        <input id="driverName" class="input" placeholder="Ex.: Salveci (Motorista)"/>

        <div class="hr"></div>

        <h2>Pessoas de confian√ßa cadastradas</h2>
        <ul id="contactsList" class="list"></ul>
        <div class="small">Cadastre at√© 3 em <b>/cadastro</b>.</div>
      </div>

      <div class="card">
        <h2>Bot√£o de P√¢nico</h2>
        <div class="sos-wrap">
          <button id="sosBtn" class="sos-btn">SOS</button>
          <div class="small" style="text-align:center;max-width:520px">
            Clique em <b>SOS</b> para enviar alerta com localiza√ß√£o e ocorr√™ncia.
            <br>‚ö†Ô∏è A sirene toca <b>somente</b> no painel da pessoa de confian√ßa.
          </div>
        </div>

        <div class="hr"></div>

        <h2>Localiza√ß√£o</h2>
        <div id="loc" class="small">Permita o acesso √† localiza√ß√£o no navegador/celular.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    let lastLoc = {lat:null,lng:null,accuracy:null};

    async function loadContacts(){
      try{
        const j = await jget("/api/contacts");
        const ul = document.getElementById("contactsList");
        ul.innerHTML = "";
        (j.contacts||[]).forEach(c=>{
          const li = document.createElement("li");
          li.innerHTML = `<b>${c.name}</b> ‚Äî ${c.phone}`;
          ul.appendChild(li);
        });
        if((j.contacts||[]).length===0){
          const li = document.createElement("li");
          li.textContent = "Nenhuma pessoa cadastrada ainda.";
          ul.appendChild(li);
        }
      }catch(e){
        toast("Falha ao carregar contatos");
      }
    }

    function clearLocal(){
      localStorage.removeItem("driver_name");
      toast("Campos limpos");
      document.getElementById("driverName").value = "";
    }

    function geo(){
      const el = document.getElementById("loc");
      if(!("geolocation" in navigator)){
        el.textContent = "Geolocaliza√ß√£o n√£o suportada.";
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          lastLoc.lat = pos.coords.latitude;
          lastLoc.lng = pos.coords.longitude;
          lastLoc.accuracy = pos.coords.accuracy;
          el.textContent = `Lat: ${lastLoc.lat.toFixed(6)} | Lng: ${lastLoc.lng.toFixed(6)} (precis√£o ~${Math.round(lastLoc.accuracy)}m)`;
        },
        ()=>{
          el.textContent = "Permita o acesso √† localiza√ß√£o no navegador/celular.";
        },
        {enableHighAccuracy:true, timeout:8000, maximumAge:15000}
      );
    }

    async function sendAlert(){
      const occ = document.getElementById("occ").value;
      const driverName = document.getElementById("driverName").value.trim();
      localStorage.setItem("driver_name", driverName);
      geo(); // refresh location best-effort

      try{
        await jpost("/api/alerts", {
          occurrence: occ,
          driver_name: driverName,
          lat: lastLoc.lat,
          lng: lastLoc.lng,
          accuracy: lastLoc.accuracy
        });
        toast("‚úÖ Alerta enviado!");
      }catch(e){
        toast("‚ùå Falha ao enviar alerta: " + e.message);
      }
    }

    document.getElementById("sosBtn").addEventListener("click", ()=>{
      sendAlert();
    });

    // restore name
    document.getElementById("driverName").value = localStorage.getItem("driver_name") || "";

    loadContacts();
    geo();
    setInterval(geo, 15000);
  </script>
</body>
</html>
