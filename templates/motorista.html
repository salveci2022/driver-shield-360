<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Driver Shield 360</title>

  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="/static/logo.png">
  <link rel="apple-touch-icon" href="/static/logo.png">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="badge">üõ°Ô∏è</div>
        <div>Driver Shield 360</div>
      </div>
    </div>

    <div class="card">
      <div class="notice">
        Sistema de apoio preventivo para motoristas de aplicativo. O alerta √© enviado para as pessoas de confian√ßa cadastradas.
      </div>

      <h2>Seu nome (ou apelido)</h2>
      <label>Ex.: Jo√£o Uber</label>
      <input id="nome" type="text" placeholder="Digite seu nome/apelido"/>

      <h2>Tipo de ocorr√™ncia</h2>
      <div class="notice">Toque em uma op√ß√£o antes de apertar o bot√£o de p√¢nico.</div>
      <div class="pills" id="pills">
        <div class="pill active" data-v="Abordagem suspeita">Abordagem suspeita</div>
        <div class="pill" data-v="Tentativa de assalto">Tentativa de assalto</div>
        <div class="pill" data-v="Passageiro agressivo">Passageiro agressivo</div>
        <div class="pill" data-v="Conflito com outro ve√≠culo">Conflito com outro ve√≠culo</div>
        <div class="pill" data-v="Emerg√™ncia de sa√∫de">Emerg√™ncia de sa√∫de</div>
        <div class="pill" data-v="Outro risco">Outro risco</div>
      </div>

      <div class="status" id="sel">Ocorr√™ncia selecionada: <b>Abordagem suspeita</b></div>

      <div class="checkbox">
        <input id="aceite" type="checkbox">
        <div>
          Declaro que li e concordo com os <a href="/termos" target="_blank" rel="noopener">Termos de Uso e Pol√≠tica de Privacidade</a>.
        </div>
      </div>

      <div class="panicWrap">
        <div class="panic" id="panicBtn" role="button" aria-label="Bot√£o de p√¢nico">
          <div>
            <span>BOT√ÉO DE P√ÇNICO</span>
            <small>TOQUE PARA ENVIAR ALERTA</small>
          </div>
        </div>
        <div class="status" id="msg"></div>
        <div class="footerNote">
          * Em risco grave, ligue imediatamente <b>190</b> (PM) / <b>192</b> (SAMU) / <b>193</b> (Bombeiros).<br>
          O Driver Shield 360 √© apoio tecnol√≥gico complementar, sujeito a internet, bateria e permiss√µes do aparelho.
        </div>
      </div>

      <div class="actions">
        <button class="btn" type="button" onclick="location.href='/cadastro'">Cadastro de pessoas de confian√ßa</button>
        <button class="btn" type="button" onclick="location.href='/relatorio'">Relat√≥rio</button>
      </div>
    </div>
  </div>

<script>
  // PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
  }

  let ocorrencia = "Abordagem suspeita";
  const pills = document.getElementById('pills');
  const sel = document.getElementById('sel');
  const msg = document.getElementById('msg');

  pills.addEventListener('click', (e) => {
    const el = e.target.closest('.pill');
    if(!el) return;
    document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
    el.classList.add('active');
    ocorrencia = el.dataset.v;
    sel.innerHTML = 'Ocorr√™ncia selecionada: <b>' + ocorrencia + '</b>';
  });

  async function getGeo(){
    return new Promise((resolve) => {
      if(!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        (p)=>resolve({lat:p.coords.latitude, lon:p.coords.longitude, acc:p.coords.accuracy}),
        ()=>resolve(null),
        {enableHighAccuracy:true, timeout:8000, maximumAge:0}
      );
    });
  }

  document.getElementById('panicBtn').addEventListener('click', async () => {
    const nome = (document.getElementById('nome').value || '').trim();
    const aceite = document.getElementById('aceite').checked;

    if(!aceite){
      msg.textContent = "Para usar, marque o aceite dos Termos.";
      return;
    }
    if(!nome){
      msg.textContent = "Digite seu nome/apelido antes de enviar.";
      return;
    }

    msg.textContent = "Enviando alerta...";
    const geo = await getGeo();

    try{
      const r = await fetch('/api/alerta', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({nome, ocorrencia, geo})
      });
      const data = await r.json().catch(()=>({ok:false}));
      if(r.ok && data.ok){
        msg.textContent = "‚úÖ Alerta enviado para as pessoas de confian√ßa.";
      }else{
        msg.textContent = "‚ö†Ô∏è N√£o foi poss√≠vel enviar agora. Verifique internet e tente novamente.";
      }
    }catch(err){
      msg.textContent = "‚ö†Ô∏è Falha de conex√£o. Verifique internet e tente novamente.";
    }
  });
</script>
</body>
</html>