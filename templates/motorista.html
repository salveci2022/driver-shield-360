
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel do Motorista - Driver Shield 360</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <meta name="theme-color" content="#00e5ff">

</head>
<body class="tela-escura">
  <header class="topo">
    <h1>üõ°Ô∏è Driver Shield 360</h1>
    <p class="subtitulo">Painel do Motorista</p>
  </header>
  <section class="bloco contatos-bloco">
    <h2>üë• Pessoas de confian√ßa</h2>
    {% if contatos and contatos|length > 0 %}
      <ul class="lista-contatos">
        {% for c in contatos %}
          <li><strong>{{ c.get('nome','') }}</strong> <span class="muted">{{ c.get('telefone','') }}</span></li>
        {% endfor %}
      </ul>
      <p class="dica">Limite: at√© 3 pessoas cadastradas.</p>
    {% else %}
      <p class="dica">Nenhuma pessoa cadastrada ainda. <a href="{{ url_for('cadastro') }}">Cadastrar agora</a></p>
    {% endif %}
  </section>

  <div class="acoes-painel acoes-motorista">
    <button type="button" class="btn btn-secundario" onclick="doFullscreen()">‚õ∂ Tela cheia</button>
    <button type="button" class="btn btn-secundario" onclick="window.location.reload(true)">Reiniciar</button>
  </div>


  <main class="container">
    <form id="form-panico">
      <label for="nome_motorista">Seu nome (ou apelido):</label>
      <input type="text" id="nome_motorista" name="nome_motorista" placeholder="Ex: Jo√£o Uber">

      <h2>Tipo de ocorr√™ncia</h2>
      <p class="texto-explicativo">
        Toque em uma das op√ß√µes abaixo antes de apertar o bot√£o de p√¢nico.
      </p>

      <div class="lista-ocorrencias">
        <button type="button" class="chip-ocorrencia selecionado" data-ocorrencia="Abordagem suspeita">Abordagem suspeita</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Tentativa de assalto">Tentativa de assalto</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Passageiro agressivo">Passageiro agressivo</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Conflito com outro ve√≠culo">Conflito com outro ve√≠culo</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Emerg√™ncia de sa√∫de">Emerg√™ncia de sa√∫de</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Outro risco">Outro risco</button>
      </div>

      <input type="hidden" id="ocorrencia" name="ocorrencia" value="Abordagem suspeita">
      <input type="hidden" id="latitude" name="latitude">
      <input type="hidden" id="longitude" name="longitude">

      <section class="area-botao-panico">
        <p id="status-localizacao" class="texto-explicativo">Tentando obter localiza√ß√£o atual...</p>
        <button id="botao-panico" type="submit" class="botao-panico">
          <span class="icone-sirene">üö®</span><br>
          BOT√ÉO DE P√ÇNICO<br>
          <small>Toque para enviar alerta</small>
        </button>
      </section>

      <div class="acoes-motorista">
        <button type="button" id="btn-limpar" class="btn btn-secundario">Limpar</button>
        <a href="{{ url_for('index') }}" class="btn btn-secundario">Sair</a>
      </div>
    </form>

    <p class="aviso-rodape">
      * Em situa√ß√£o real de risco grave, ligue imediatamente <strong>190</strong> ou atendimento de emerg√™ncia da sua regi√£o.<br>
      Este sistema √© um apoio extra de prote√ß√£o e registro t√©cnico.
    </p>
  </main>

  <script>
    // sele√ß√£o de ocorr√™ncia visual
    document.querySelectorAll('.chip-ocorrencia').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.chip-ocorrencia').forEach(function(b) {
          b.classList.remove('selecionado');
        });
        btn.classList.add('selecionado');
        document.getElementById('ocorrencia').value = btn.dataset.ocorrencia;
      });
    });

    // obter localiza√ß√£o
    function atualizarStatus(msg) {
      document.getElementById('status-localizacao').textContent = msg;
    }

    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
        document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
        atualizarStatus('Localiza√ß√£o capturada com sucesso.');
      }, function(err) {
        atualizarStatus('N√£o foi poss√≠vel obter a localiza√ß√£o autom√°tica. Voc√™ ainda pode enviar o alerta.');
      });
    } else {
      atualizarStatus('Seu navegador n√£o suporta geolocaliza√ß√£o. Voc√™ ainda pode enviar o alerta.');
    }

    // envio do formul√°rio (bot√£o de p√¢nico)
    document.getElementById('form-panico').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('botao-panico');
      btn.disabled = true;
      btn.classList.add('ativo');

      const payload = {
        nome_motorista: document.getElementById('nome_motorista').value,
        ocorrencia: document.getElementById('ocorrencia').value,
        latitude: document.getElementById('latitude').value,
        longitude: document.getElementById('longitude').value
      };

      try {
        const resp = await fetch('{{ url_for("api_panico") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        alert('üö® Alerta enviado com sucesso!');
      } catch (err) {
        alert('Erro ao enviar alerta. Verifique sua conex√£o.');
      } finally {
        btn.disabled = false;
        btn.classList.remove('ativo');
      }
    });

    // limpar campos
    document.getElementById('btn-limpar').addEventListener('click', function() {
      document.getElementById('nome_motorista').value = '';
      document.getElementById('latitude').value = '';
      document.getElementById('longitude').value = '';
      atualizarStatus('Campos limpos. Tentando obter localiza√ß√£o novamente...');
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
          document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
          atualizarStatus('Localiza√ß√£o capturada com sucesso.');
        }, function(err) {
          atualizarStatus('N√£o foi poss√≠vel obter a localiza√ß√£o autom√°tica.');
        });
      }
    });
  </script>
<script>
function doFullscreen(){ const el=document.documentElement; if(el.requestFullscreen) el.requestFullscreen(); }
</script>
</body>
</html>
