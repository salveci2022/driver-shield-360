
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Painel do Motorista - Driver Shield 360</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<link rel="icon" href="/static/favicon.ico">
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#00ff88">
</head>
<body class="tela-escura">
  <header class="topo">
    <h1>ğŸ›¡ï¸ Driver Shield 360</h1>
    <p class="subtitulo">Painel do Motorista</p>
  <div class="header-actions"><button id="btnFull" class="btn secondary">Tela cheia</button></div></header>

  <main class="container">
    <form id="form-panico">
      <label for="nome_motorista">Seu nome (ou apelido):</label>
      <input type="text" id="nome_motorista" name="nome_motorista" placeholder="Ex: JoÃ£o Uber">

      <h2>Tipo de ocorrÃªncia</h2>
      <p class="texto-explicativo">
        Toque em uma das opÃ§Ãµes abaixo antes de apertar o botÃ£o de pÃ¢nico.
      </p>

      <div class="lista-ocorrencias">
        <button type="button" class="chip-ocorrencia selecionado" data-ocorrencia="Abordagem suspeita">Abordagem suspeita</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Tentativa de assalto">Tentativa de assalto</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Passageiro agressivo">Passageiro agressivo</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Conflito com outro veÃ­culo">Conflito com outro veÃ­culo</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="EmergÃªncia de saÃºde">EmergÃªncia de saÃºde</button>
        <button type="button" class="chip-ocorrencia" data-ocorrencia="Outro risco">Outro risco</button>
      </div>

      <input type="hidden" id="ocorrencia" name="ocorrencia" value="Abordagem suspeita">
      <input type="hidden" id="latitude" name="latitude">
      <input type="hidden" id="longitude" name="longitude">

      <section class="area-botao-panico">
        <p id="status-localizacao" class="texto-explicativo">Tentando obter localizaÃ§Ã£o atual...</p>
        <button id="botao-panico" type="submit" class="botao-panico">
          <span class="icone-sirene">ğŸš¨</span><br>
          BOTÃƒO DE PÃ‚NICO<br>
          <small>Toque para enviar alerta</small>
        </button>
      </section>

      <div class="acoes-motorista">
        <button type="button" id="btn-limpar" class="btn btn-secundario">Limpar</button>
        <a href="{{ url_for('index') }}" class="btn btn-secundario">Sair</a>
      </div>
    </form>
    <section class="box">
      <h2>ğŸ‘¥ Pessoas de confianÃ§a cadastradas (mÃ¡x. 3)</h2>
      <ul class="contact-list">
        {% if contatos %}
          {% for c in contatos %}
            <li><strong>{{ c.nome }}</strong> â€” {{ c.telefone }}{% if c.parentesco %} <span class="muted">({{ c.parentesco }})</span>{% endif %}</li>
          {% endfor %}
        {% else %}
          <li class="muted">Nenhuma pessoa cadastrada ainda. Acesse <a href="/cadastro">/cadastro</a> para cadastrar.</li>
        {% endif %}
      </ul>
    </section>


    <p class="aviso-rodape">
      * Em situaÃ§Ã£o real de risco grave, ligue imediatamente <strong>190</strong> ou atendimento de emergÃªncia da sua regiÃ£o.<br>
      Este sistema Ã© um apoio extra de proteÃ§Ã£o e registro tÃ©cnico.
    </p>
  </main>

  <script>
    // seleÃ§Ã£o de ocorrÃªncia visual
    document.querySelectorAll('.chip-ocorrencia').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.chip-ocorrencia').forEach(function(b) {
          b.classList.remove('selecionado');
        });
        btn.classList.add('selecionado');
        document.getElementById('ocorrencia').value = btn.dataset.ocorrencia;
      });
    });

    // obter localizaÃ§Ã£o
    function atualizarStatus(msg) {
      document.getElementById('status-localizacao').textContent = msg;
    }

    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
        document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
        atualizarStatus('LocalizaÃ§Ã£o capturada com sucesso.');
      }, function(err) {
        atualizarStatus('NÃ£o foi possÃ­vel obter a localizaÃ§Ã£o automÃ¡tica. VocÃª ainda pode enviar o alerta.');
      });
    } else {
      atualizarStatus('Seu navegador nÃ£o suporta geolocalizaÃ§Ã£o. VocÃª ainda pode enviar o alerta.');
    }

    // envio do formulÃ¡rio (botÃ£o de pÃ¢nico)
    document.getElementById('form-panico').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('botao-panico');
      btn.disabled = true;
      btn.classList.add('ativo');

      const payload = {
        nome_motorista: document.getElementById('nome_motorista').value,
        ocorrencia: document.getElementById('ocorrencia').value,
        latitude: document.getElementById('latitude').value,
        longitude: document.getElementById('longitude').value
      };

      try {
        const resp = await fetch('{{ url_for("api_panico") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        alert('ğŸš¨ Alerta enviado com sucesso!');
      } catch (err) {
        alert('Erro ao enviar alerta. Verifique sua conexÃ£o.');
      } finally {
        btn.disabled = false;
        btn.classList.remove('ativo');
      }
    });

    // limpar campos
    document.getElementById('btn-limpar').addEventListener('click', function() {
      document.getElementById('nome_motorista').value = '';
      document.getElementById('latitude').value = '';
      document.getElementById('longitude').value = '';
      atualizarStatus('Campos limpos. Tentando obter localizaÃ§Ã£o novamente...');
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
          document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
          atualizarStatus('LocalizaÃ§Ã£o capturada com sucesso.');
        }, function(err) {
          atualizarStatus('NÃ£o foi possÃ­vel obter a localizaÃ§Ã£o automÃ¡tica.');
        });
      }
    });
  
const btnFull=document.getElementById('btnFull');
if(btnFull){btnFull.addEventListener('click',()=>{const el=document.documentElement; if(!document.fullscreenElement){el.requestFullscreen?.();} else {document.exitFullscreen?.();}})}
</script>
</body>
</html>
