<!doctype html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" type="image/png" href="/static/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#0a0014">
  <meta charset="utf-8">
  <title>Motorista - Driver Shield 360</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">ğŸš• Painel do Motorista</div>
        <div class="row">
          <button class="btn small" onclick="goFull()">â›¶ Tela cheia</button>
          <button class="btn small" onclick="location.reload()">ğŸ”„ Atualizar</button>
          <a class="btn small" href="/">Sair</a>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="title" style="font-size:18px">Tipo de ocorrÃªncia</div>

          <label>Selecione</label>
          <select id="ocorrencia" class="input">
            <option value="Abordagem suspeita">Abordagem suspeita</option>
            <option value="Tentativa de assalto">Tentativa de assalto</option>
            <option value="AmeaÃ§a / intimidaÃ§Ã£o">AmeaÃ§a / intimidaÃ§Ã£o</option>
            <option value="Passageiro agressivo">Passageiro agressivo</option>
            <option value="Seguimento / perseguiÃ§Ã£o">Seguimento / perseguiÃ§Ã£o</option>
            <option value="EmergÃªncia mÃ©dica">EmergÃªncia mÃ©dica</option>
            <option value="Outro">Outro</option>
          </select>

          <label>Seu nome (opcional)</label>
          <input id="motoristaNome" class="input" placeholder="Ex: JoÃ£o (Uber)">

          <hr>

          <div class="title" style="font-size:18px">Pessoas de confianÃ§a cadastradas</div>
          {% if contacts and contacts|length > 0 %}
            <ul>
              {% for c in contacts %}
                <li><b>{{ c.nome }}</b> â€” {{ c.telefone }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="notice">Nenhuma pessoa cadastrada ainda. VÃ¡ em â€œCadastroâ€.</div>
          {% endif %}
        </div>

        <div class="card">
          <div class="title" style="font-size:18px">BotÃ£o de PÃ¢nico</div>

          <div class="sos-wrap">
            <button id="sosBtn" class="sos-btn" onclick="enviar()">SOS</button>
          </div>

          <div id="status" class="notice">
            Clique em <b>SOS</b> para enviar alerta com localizaÃ§Ã£o e ocorrÃªncia.
          </div>

          <hr>

          <div class="title" style="font-size:18px">LocalizaÃ§Ã£o</div>
          <div class="notice" id="locTxt">Aguardando localizaÃ§Ã£oâ€¦</div>
          <div class="notice" style="margin-top:8px" id="locHint">
            Dica: se o GPS estiver errado, ative â€œAlta PrecisÃ£oâ€ nas configuraÃ§Ãµes do celular.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function goFull(){
      const el=document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen();
    }

    // OcorrÃªncia jÃ¡ prÃ©-selecionada
    document.getElementById("ocorrencia").selectedIndex = 0;

    let lastPos = null;
    let watchId = null;

    function setLocText(txt){
      document.getElementById('locTxt').textContent = txt;
    }

    function startLocation(){
      if(!navigator.geolocation){
        setLocText('GeolocalizaÃ§Ã£o nÃ£o disponÃ­vel neste dispositivo.');
        return;
      }

      // watchPosition tende a ficar mais â€œvivoâ€ no celular do que getCurrentPosition
      if(watchId != null){
        try{ navigator.geolocation.clearWatch(watchId); }catch(e){}
      }

      watchId = navigator.geolocation.watchPosition((pos)=>{
        lastPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
        setLocText(`Lat: ${lastPos.lat.toFixed(6)} | Lng: ${lastPos.lng.toFixed(6)} (precisÃ£o: ~${Math.round(lastPos.acc)}m)`);
      }, (err)=>{
        setLocText('Permita o acesso Ã  localizaÃ§Ã£o no navegador/celular.');
      }, {
        enableHighAccuracy: true,
        timeout: 12000,
        maximumAge: 0
      });
    }

    startLocation();

    async function enviar(){
      const btn = document.getElementById('sosBtn');
      btn.disabled = true;

      const ocorrencia = document.getElementById('ocorrencia').value;
      const motorista = (document.getElementById('motoristaNome').value || 'Motorista').trim();

      // Tenta pegar uma posiÃ§Ã£o â€œmais recenteâ€ no momento do SOS
      await new Promise((resolve)=>{
        if(!navigator.geolocation){ resolve(); return; }
        navigator.geolocation.getCurrentPosition((pos)=>{
          lastPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
          resolve();
        }, ()=>resolve(), { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
      });

      const payload = {
        motorista,
        ocorrencia,
        lat: lastPos ? lastPos.lat : null,
        lng: lastPos ? lastPos.lng : null
      };

      try{
        const res = await fetch('/api/panic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const j = await res.json();

        if(j.ok){
          btn.classList.add('sent');
          btn.textContent = 'ENVIADO';
          document.getElementById('status').textContent = 'âœ… Alerta enviado com sucesso. Aguarde atendimento.';
        }else{
          document.getElementById('status').textContent = 'âŒ Falha ao enviar alerta.';
        }
      }catch(e){
        document.getElementById('status').textContent = 'âŒ Erro de conexÃ£o (Render). Tente novamente.';
      }

      // Volta ao normal automaticamente
      setTimeout(()=>{
        btn.disabled = false;
        btn.classList.remove('sent');
        btn.textContent = 'SOS';
      }, 6000);
    }
  </script>
</body>
</html>
