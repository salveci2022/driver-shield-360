<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Driver Shield 360 - Motorista</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="dark">
    <div class="container motorista-container">
        <h1>üõ°Ô∏è Driver Shield 360</h1>
        <p class="subtitle">
            Sistema de prote√ß√£o para motoristas de aplicativo.<br />
            O alerta ser√° enviado para as pessoas de confian√ßa cadastradas.
        </p>

        <label for="driverName">Seu nome (ou apelido):</label>
        <input id="driverName" type="text" placeholder="Ex: Jo√£o Uber" />

        <h2 class="section-title">Tipo de ocorr√™ncia</h2>
        <p class="hint">
            Toque em uma das op√ß√µes abaixo antes de apertar o bot√£o de p√¢nico.
        </p>

        <div class="occurrence-grid">
            <button class="occ-btn" data-occ="Abordagem suspeita">Abordagem suspeita</button>
            <button class="occ-btn" data-occ="Tentativa de assalto">Tentativa de assalto</button>
            <button class="occ-btn" data-occ="Passageiro agressivo">Passageiro agressivo</button>
            <button class="occ-btn" data-occ="Conflito com outro ve√≠culo">Conflito com outro ve√≠culo</button>
            <button class="occ-btn" data-occ="Emerg√™ncia de sa√∫de (motorista ou passageiro)">Emerg√™ncia de sa√∫de</button>
            <button class="occ-btn" data-occ="Outro risco durante a corrida">Outro risco</button>
        </div>

        <input type="hidden" id="occurrence" value="Abordagem suspeita" />

        <p id="selectedOccText" class="selected-occ-text">Ocorr√™ncia selecionada: <strong>Abordagem suspeita</strong></p>

        <div class="panic-wrapper">
            <button id="panicButton" class="panic-btn-round">
                <span class="panic-icon">üö®</span>
                <span class="panic-text-top">BOT√ÉO DE P√ÇNICO</span>
                <span class="panic-text-bottom">TOQUE PARA ENVIAR ALERTA</span>
            </button>
        </div>

        <h2 class="section-title">Pessoas de confian√ßa cadastradas</h2>
        <ul id="contactsList" class="contacts-list">
            <li>Carregando contatos...</li>
        </ul>

        <p id="gpsStatus" class="status-text"></p>
        <p id="status" class="status-text"></p>

        <p class="hint">
            * Em situa√ß√£o real de risco grave, ligue imediatamente 190.<br />
            Este sistema √© um apoio extra de prote√ß√£o e registro t√©cnico.
        </p>
    </div>

    <script>
        const panicButton = document.getElementById('panicButton');
        const gpsStatus = document.getElementById('gpsStatus');
        const selectedOccText = document.getElementById('selectedOccText');
        const statusText = document.getElementById('status');
        const contactsList = document.getElementById('contactsList');
        const occurrenceInput = document.getElementById('occurrence');
        const occButtons = document.querySelectorAll('.occ-btn');

        // Sele√ß√£o visual das ocorr√™ncias
        occButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                occButtons.forEach(b => b.classList.remove('occ-selected'));
                btn.classList.add('occ-selected');
                const occ = btn.getAttribute('data-occ');
                occurrenceInput.value = occ;
                if (selectedOccText) {
                    selectedOccText.innerHTML = 'Ocorr√™ncia selecionada: <strong>' + occ + '</strong>';
                }
            });
        });

        // Deixa a primeira op√ß√£o selecionada visualmente
        if (occButtons.length) {
            occButtons[0].classList.add('occ-selected');
        }

        function loadContacts() {
            fetch('/api/contacts')
                .then(res => res.json())
                .then(data => {
                    contactsList.innerHTML = "";
                    if (!data.length) {
                        contactsList.innerHTML = "<li>Nenhuma pessoa de confian√ßa cadastrada ainda.</li>";
                        return;
                    }
                    data.slice(0,3).forEach(c => {
                        const li = document.createElement('li');
                        li.textContent = c.name + " (" + c.login + ")";
                        contactsList.appendChild(li);
                    });
                })
                .catch(err => {
                    console.error(err);
                    contactsList.innerHTML = "<li>Erro ao carregar contatos.</li>";
                });
        }

        function sendPanicAlert(lat, lng) {
            const driverName = document.getElementById('driverName').value || "Motorista";
            const occurrence = occurrenceInput.value || "Ocorr√™ncia n√£o informada";

            fetch('/api/panic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    driver_name: driverName,
                    lat: lat,
                    lng: lng,
                    occurrence: occurrence
                })
            })
            .then(res => res.json())
            .then(data => {
                statusText.textContent = "Alerta enviado para as pessoas de confian√ßa cadastradas! ‚úÖ";
                panicButton.classList.add('panic-sent');
            })
            .catch(err => {
                console.error(err);
                statusText.textContent = "Erro ao enviar alerta. Tente novamente.";
            });
        }

        panicButton.addEventListener('click', () => {
            statusText.textContent = "Coletando localiza√ß√£o em tempo real...";

            if (!navigator.geolocation) {
                statusText.textContent = "Geolocaliza√ß√£o n√£o suportada neste dispositivo.";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    if (gpsStatus) {
                        gpsStatus.textContent = "Localiza√ß√£o obtida: lat " + lat.toFixed(5) + ", lng " + lng.toFixed(5);
                    }
                    statusText.textContent = "Localiza√ß√£o obtida com sucesso. Enviando alerta...";
                    sendPanicAlert(lat, lng);
                },
                (err) => {
                    console.error(err);
                    if (gpsStatus) {
                        gpsStatus.textContent = "O navegador bloqueou ou n√£o conseguiu acessar o GPS deste aparelho.";
                    }
                    statusText.textContent = "N√£o foi poss√≠vel obter a localiza√ß√£o autom√°tica. Enviando alerta mesmo assim, sem GPS.";
                    // envia mesmo sem localiza√ß√£o para n√£o perder o registro da ocorr√™ncia
                    sendPanicAlert(null, null);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        });

        // Carrega contatos na abertura
        loadContacts();
    </script>

    <div class="motorista-extra-actions" style="margin-top:24px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
        <button type="button" onclick="limparAlertas()" class="btn-secondary">
            Limpar alertas
        </button>
        <button type="button" onclick="recarregarPagina()" class="btn-secondary">
            Reiniciar painel
        </button>
        <button type="button" onclick="abrirRelatorio()" class="btn-secondary">
            Relat√≥rio de ocorr√™ncias
        </button>
        <button type="button" onclick="sairDoSistema()" class="btn-danger">
            Sair
        </button>
    </div>

    <script>
        function limparAlertas() {
            if (!confirm("Deseja limpar todos os alertas registrados?")) return;

            fetch("/api/clear_alerts", { method: "POST" })
                .then(function(res) {
                    if (res.ok) {
                        alert("Alertas limpos com sucesso.");
                        location.reload();
                    } else {
                        alert("N√£o foi poss√≠vel limpar os alertas.");
                    }
                })
                .catch(function() {
                    alert("Erro ao comunicar com o servidor.");
                });
        }

        function recarregarPagina() {
            location.reload();
        }

        function abrirRelatorio() {
            window.location.href = "/relatorio";
        }

        function sairDoSistema() {
            // se existir rota /logout, use ela, sen√£o apenas volta para a home
            window.location.href = "/";
        }
    </script>

</body>
</html>
