<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Motorista | {{ app_name }}</title>
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" href="/static/icons/icon-192x192.png">
  <link rel="stylesheet" href="/static/style.css"/>
  <style>
    /* garantir legibilidade do select/option em todos os browsers */
    select, option { color:#fff; background:#120016; }
    option { background:#16002b; }
    .top-actions button{min-width:120px}
    .pill{display:inline-flex;gap:.5rem;align-items:center;padding:.45rem .8rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .contacts{margin-top:10px}
    .contacts ul{margin:8px 0 0 18px}
    .contacts li{margin:6px 0}
    .sos{
      width:220px;height:220px;border-radius:50%;
      display:grid;place-items:center;
      font-size:54px;font-weight:800;letter-spacing:2px;
      border:none; cursor:pointer;
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      background: radial-gradient(circle at 30% 30%, #ff78df, #b84bff 60%, #5e2a86);
      color:#fff;
      transition: transform .08s ease;
    }
    .sos:active{transform:scale(.98)}
    .hint{opacity:.9}
    .warn{opacity:.85;font-size:.95rem}
  </style>
</head>
<body class="aurora-bg">
  <div class="wrap">
    <header class="topbar">
      <div>
        <h1>üöó Painel do Motorista</h1>
        <p class="hint">Um toque para enviar alerta com ocorr√™ncia e localiza√ß√£o.</p>
      </div>

      <div class="top-actions">
        <button class="btn" id="btnFull">‚õ∂ Tela cheia</button>
        <button class="btn" id="btnReload">‚Üª Reiniciar</button>
        <button class="btn btn-danger" id="btnClear">üßπ Limpar alertas</button>
        <button class="btn" id="btnExit">‚Üê Sair</button>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <h2>Configura√ß√£o r√°pida</h2>

        <label class="label">Tipo de ocorr√™ncia (pr√©-selecionado)</label>
        <select id="occurrence">
          {% for o in occurrences %}
            <option value="{{o}}" {% if loop.index0==0 %}selected{% endif %}>{{o}}</option>
          {% endfor %}
        </select>

        <label class="label">Seu nome (opcional)</label>
        <input id="driverName" placeholder="Ex: Jo√£o (Uber)" />

        <div class="contacts">
          <div class="pill">üë• Pessoas de confian√ßa cadastradas</div>
          {% if contacts and contacts|length > 0 %}
            <ul>
              {% for c in contacts %}
                <li><strong>{{c.name}}</strong> ‚Äî {{c.phone}}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="warn">Nenhuma pessoa cadastrada. V√° em <strong>/cadastro</strong> e cadastre at√© 3 contatos.</p>
          {% endif %}
        </div>
      </section>

      <section class="card">
        <h2>Bot√£o de P√¢nico</h2>

        <div class="center">
          <button class="sos" id="btnSOS">SOS</button>
        </div>

        <p class="hint">Clique em <strong>SOS</strong> para enviar alerta com localiza√ß√£o e ocorr√™ncia.</p>
        <p class="warn">‚ö†Ô∏è A sirene toca <strong>somente</strong> no painel da pessoa de confian√ßa.</p>

        <div class="hr"></div>

        <div>
          <h3>Localiza√ß√£o</h3>
          <div id="locText" class="muted">Permita o acesso √† localiza√ß√£o no navegador/celular.</div>
        </div>
      </section>
    </main>
  </div>

<script>
  // PWA
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); }

  const locText = document.getElementById('locText');
  let lastLoc = null;

  function getLocationOnce() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        lastLoc = {
          lat: +pos.coords.latitude.toFixed(6),
          lng: +pos.coords.longitude.toFixed(6),
          accuracy: Math.round(pos.coords.accuracy || 0)
        };
        locText.textContent = `Lat: ${lastLoc.lat} | Lng: ${lastLoc.lng} (precis√£o ~${lastLoc.accuracy}m)`;
      },
      () => { locText.textContent = 'Permita o acesso √† localiza√ß√£o no navegador/celular.'; },
      { enableHighAccuracy:true, timeout:8000, maximumAge:10000 }
    );
  }
  getLocationOnce();

  async function sendSOS() {
    const occurrence = document.getElementById('occurrence').value || 'Abordagem suspeita';
    const driverName = document.getElementById('driverName').value || '';

    // tenta atualizar a localiza√ß√£o rapidinho antes do envio
    try { await new Promise((res)=>{ 
      if(!navigator.geolocation){res();return;}
      navigator.geolocation.getCurrentPosition((pos)=>{
        lastLoc = {
          lat: +pos.coords.latitude.toFixed(6),
          lng: +pos.coords.longitude.toFixed(6),
          accuracy: Math.round(pos.coords.accuracy || 0)
        };
        locText.textContent = `Lat: ${lastLoc.lat} | Lng: ${lastLoc.lng} (precis√£o ~${lastLoc.accuracy}m)`;
        res();
      }, ()=>res(), { enableHighAccuracy:true, timeout:5000, maximumAge:0 });
    }); } catch(e){}

    const payload = {
      occurrence,
      driver_name: driverName,
      lat: lastLoc ? lastLoc.lat : null,
      lng: lastLoc ? lastLoc.lng : null,
      accuracy: lastLoc ? lastLoc.accuracy : null,
    };

    const r = await fetch('/api/alert', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if (r.ok) {
      const btn = document.getElementById('btnSOS');
      btn.textContent = 'ENVIADO';
      setTimeout(()=>btn.textContent='SOS', 1200);
    } else {
      alert('N√£o foi poss√≠vel enviar o alerta. Tente novamente.');
    }
  }

  document.getElementById('btnSOS').addEventListener('click', sendSOS);

  document.getElementById('btnFull').addEventListener('click', ()=>{
    const el = document.documentElement;
    if (!document.fullscreenElement) el.requestFullscreen?.();
    else document.exitFullscreen?.();
  });
  document.getElementById('btnReload').addEventListener('click', ()=>location.reload());
  document.getElementById('btnExit').addEventListener('click', ()=>location.href='/');
  document.getElementById('btnClear').addEventListener('click', async ()=>{
    await fetch('/api/alerts', {method:'DELETE'});
    alert('Alertas limpos.');
  });
</script>
</body>
</html>
