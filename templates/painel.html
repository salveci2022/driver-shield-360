<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel ‚Äî Pessoa de Confian√ßa</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="app">
  <div class="container fullscreen">
    <header class="topbar">
      <div>
        <h1>Painel da Pessoa de Confian√ßa</h1>
        <p class="muted">Aberto e sempre dispon√≠vel (sem senha)</p>
      </div>
      <div class="actions">
        <button class="btn" id="btnSiren">üîä Sirene</button>
        <button class="btn" id="btnClear">üßπ Limpar</button>
        <button class="btn" id="btnReload">üîÑ Reiniciar</button>
        <a class="btn danger" href="{{ url_for('logout') }}">‚èª Sair</a>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <h2>Alertas em tempo real</h2>
        <p class="muted">Quando chegar um novo alerta, a sirene toca automaticamente.</p>
        <div id="alerts" class="alerts"></div>
      </section>

      <section class="card">
        <h2>Dicas r√°pidas</h2>
        <ul class="list">
          <li>Se tocar sirene, verifique o alerta mais recente.</li>
          <li>Use <strong>Limpar</strong> ap√≥s resolver a ocorr√™ncia.</li>
          <li>Use <strong>Reiniciar</strong> se a tela travar.</li>
        </ul>
      </section>
    </main>
  </div>

  <audio id="sireneAudio" src="{{ url_for('static', filename='sirene.mp3') }}" preload="auto" loop></audio>

  <script>
    const $alerts = document.getElementById('alerts');
    const sirene = document.getElementById('sireneAudio');
    const btnSiren = document.getElementById('btnSiren');
    const btnClear = document.getElementById('btnClear');
    const btnReload = document.getElementById('btnReload');

    let lastCount = 0;
    let sirenOn = false;

    function renderAlerts(items){
      if(!items || items.length === 0){
        $alerts.innerHTML = '<div class="empty">Nenhum alerta no momento.</div>';
        return;
      }
      const html = items.slice().reverse().map(a => {
        const hora = a.hora || '';
        const tipo = a.tipo || 'Alerta';
        const local = a.local || '';
        const msg = a.mensagem || '';
        return `
          <div class="alert-item">
            <div class="alert-head">
              <strong>${tipo}</strong>
              <span class="muted">${hora}</span>
            </div>
            <div class="muted">${local}</div>
            ${msg ? `<div>${msg}</div>` : ''}
          </div>
        `;
      }).join('');
      $alerts.innerHTML = html;
    }

    function startSiren(){
      try{ sirene.currentTime = 0; sirene.play(); }catch(e){}
      sirenOn = true;
      btnSiren.textContent = 'üîá Parar';
      btnSiren.classList.add('danger');
    }

    function stopSiren(){
      try{ sirene.pause(); }catch(e){}
      sirenOn = false;
      btnSiren.textContent = 'üîä Sirene';
      btnSiren.classList.remove('danger');
    }

    btnSiren.addEventListener('click', () => {
      sirenOn ? stopSiren() : startSiren();
    });

    btnReload.addEventListener('click', () => location.reload());

    btnClear.addEventListener('click', async () => {
      try{
        await fetch('/api/limpar_alertas', {method:'POST'});
      }catch(e){}
      lastCount = 0;
      stopSiren();
      await fetchAlerts();
    });

    async function fetchAlerts(){
      try{
        const r = await fetch('/api/alertas', {cache:'no-store'});
        const data = await r.json();
        const items = data.alertas || [];
        renderAlerts(items);

        if(items.length > lastCount && lastCount !== 0){
          // chegou alerta novo
          startSiren();
        }
        lastCount = items.length;
      }catch(e){
        $alerts.innerHTML = '<div class="empty">Erro ao carregar alertas.</div>';
      }
    }

    // primeira carga
    fetchAlerts();
    // atualiza√ß√£o cont√≠nua
    setInterval(fetchAlerts, 2000);
  </script>
</body>
</html>
