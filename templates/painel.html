<!doctype html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" type="image/png" href="/static/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#0a0014">
  <meta charset="utf-8">
  <title>Pessoa de Confian√ßa - Driver Shield 360</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">üßë‚Äçü§ù‚Äçüßë Painel da Pessoa de Confian√ßa</div>
        <div class="row">
          <button class="btn small" onclick="goFull()">‚õ∂ Tela cheia</button>
          <button class="btn small" onclick="location.reload()">üîÑ Atualizar</button>
          <button class="btn small danger" onclick="limpar()">üßπ Limpar</button>
          <button class="btn small danger" onclick="toggleSirene()">üîä Sirene</button>
          <a class="btn small" href="{{ url_for('pessoa_sair') }}">Sair</a>
        </div>
      </div>

      <div class="notice" id="audioHint">
        Este painel √© <b>aberto</b> (sem senha).
        Para o som funcionar no celular, toque em <b>Sirene</b> 1 vez para liberar o √°udio.
        Depois disso, quando chegar um novo alerta a sirene pode tocar automaticamente.
      </div>

      <hr>

      <div class="grid">
        <div class="card">
          <div class="title" style="font-size:18px">√öltimo alerta</div>
          <div id="ultimo" class="notice">Aguardando alerta‚Ä¶</div>

          <hr>

          <div class="title" style="font-size:18px">Mapa</div>
          <iframe id="mapa" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>

          <div id="mapLinkWrap" style="margin-top:10px; display:none">
            <a id="mapLink" class="btn small" target="_blank">üó∫Ô∏è Abrir no Google Maps</a>
          </div>
        </div>

        <div class="card">
          <div class="title" style="font-size:18px">Lista de alertas</div>
          <div id="lista" class="notice">‚Äî</div>
        </div>
      </div>

      <audio id="sireneAudio" preload="auto" loop>
        <source src="{{ url_for('static', filename='sirene.mp3') }}" type="audio/mpeg">
      </audio>
    </div>
  </div>

  <script>
    function goFull(){
      const el=document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen();
    }

    // Sirene: precisa de intera√ß√£o do usu√°rio pelo menos 1x no celular.
    let sireneOn=false;
    let audioLiberado=false;

    function _playSirene(){
      const audio=document.getElementById('sireneAudio');
      audio.volume=1.0;
      return audio.play().then(()=>{
        sireneOn=true;
      }).catch(()=>{
        // Se n√£o liberar √°udio, pede novamente.
        document.getElementById('audioHint').innerHTML =
          '‚ö†Ô∏è O navegador bloqueou o √°udio. Toque no bot√£o <b>Sirene</b> uma vez para liberar.';
        throw new Error('Audio bloqueado');
      });
    }

    function _stopSirene(){
      const audio=document.getElementById('sireneAudio');
      audio.pause();
      audio.currentTime=0;
      sireneOn=false;
    }

    function toggleSirene(){
      const audio=document.getElementById('sireneAudio');
      if(!audioLiberado){
        // Primeiro toque: libera √°udio (e j√° toca 1x como teste)
        _playSirene().then(()=>{
          audioLiberado=true;
          // Para n√£o ficar tocando sem necessidade, j√° desliga e deixa pronto pro autom√°tico.
          setTimeout(()=>{ _stopSirene(); }, 1200);
          document.getElementById('audioHint').innerHTML =
            '‚úÖ √Åudio liberado. A sirene poder√° tocar automaticamente quando chegar um novo alerta.';
        }).catch(()=>{});
        return;
      }

      // Depois de liberado: vira liga/desliga manual
      if(!sireneOn){
        _playSirene().catch(()=>{});
      } else {
        _stopSirene();
      }
    }

    let lastCount = -1; // for√ßa comparar no primeiro poll

    function setMapa(lat,lng){
      const iframe=document.getElementById('mapa');
      const linkWrap=document.getElementById('mapLinkWrap');
      const link=document.getElementById('mapLink');

      if(lat==null || lng==null || lat==="" || lng===""){
        iframe.srcdoc="<div style='padding:14px;color:#cdb7e6;font-family:system-ui'>Sem localiza√ß√£o neste alerta.</div>";
        linkWrap.style.display="none";
        return;
      }

      iframe.src=`https://www.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
      link.href=`https://www.google.com/maps?q=${lat},${lng}&z=16`;
      linkWrap.style.display="block";
    }

    function renderAlert(a){
      const el=document.getElementById('ultimo');
      const lat=a.lat, lng=a.lng;

      const localTxt = (lat!=null && lng!=null && lat!=="" && lng!=="") ? (lat + ", " + lng) : "‚Äî";
      el.innerHTML = `
        <div><b>Hor√°rio:</b> ${a.ts}</div>
        <div><b>Motorista:</b> ${a.motorista}</div>
        <div><b>Ocorr√™ncia:</b> ${a.ocorrencia}</div>
        <div><b>Local:</b> ${localTxt}</div>
      `;

      setMapa(lat,lng);
      document.title = `ALERTA - ${a.ocorrencia}`;
    }

    function renderLista(alerts){
      const box=document.getElementById('lista');
      if(!alerts.length){
        box.textContent='Nenhum alerta ainda.';
        return;
      }
      box.innerHTML = alerts.slice().reverse().map(a=>`
        <div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.10)">
          <div><b>${a.ts}</b> ‚Äî ${a.ocorrencia}</div>
          <div style="color:#cdb7e6">Motorista: ${a.motorista}</div>
        </div>
      `).join('');
    }

    async function poll(){
      try{
        const res=await fetch('/api/alerts',{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP ' + res.status);

        const alerts=await res.json();
        renderLista(alerts);

        if(alerts.length){
          renderAlert(alerts[alerts.length-1]);
        } else {
          document.title = 'Pessoa de Confian√ßa - Driver Shield 360';
        }

        // Auto-sirene: toca quando chegar novo alerta (se √°udio j√° liberado)
        if(lastCount !== -1 && alerts.length > lastCount){
          if(audioLiberado){
            _playSirene().catch(()=>{});
          } else {
            document.getElementById('audioHint').innerHTML =
              'üö® Chegou um alerta! Toque em <b>Sirene</b> para liberar o √°udio e atender mais r√°pido.';
          }
        }

        lastCount = alerts.length;
      }catch(e){
        // Mostra estado de falha sem travar
        document.getElementById('ultimo').innerHTML =
          "<b>‚ö†Ô∏è Falha ao buscar alertas.</b><br>Verifique se o servidor est√° online no Render e tente atualizar.";
      }
    }

    poll();
    setInterval(poll, 3000);

    async function limpar(){
      if(!confirm('Limpar todos os alertas?')) return;

      try{
        const res=await fetch('/api/clear_alerts',{method:'POST'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const j=await res.json();

        if(j.ok){
          lastCount = 0;
          _stopSirene();
          alert('‚úÖ Alertas limpos!');
          location.reload();
        } else {
          alert('‚ùå Falha ao limpar. Tente novamente.');
        }
      }catch(e){
        alert('‚ùå Erro ao comunicar com o servidor (Render).');
      }
    }
  </script>
</body>
</html>
