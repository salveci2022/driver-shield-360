<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pessoa de ConfianÃ§a | {{ app_name }}</title>
  <link rel="icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <audio id="sireneAudio" src="{{ url_for('static', filename='sirene.mp3') }}" preload="auto"></audio>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <span style="font-size:20px">ğŸ‘¥</span>
        <div>
          <div style="font-size:20px">Painel da Pessoa de ConfianÃ§a</div>
          <div class="small">Aqui a sirene toca quando chega um SOS.</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" onclick="setFullScreen()">â›¶ Tela cheia</button>
        <button class="btn ghost" onclick="location.reload()">â†» Reiniciar</button>
        <button class="btn danger" onclick="clearAlerts()">ğŸ§¹ Limpar alertas</button>
        <a class="btn" href="/">âŸµ Sair</a>
      </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr;">
      <div class="card">
        <h2>Alertas em tempo real</h2>
        <div class="small">Atualiza automaticamente a cada 3 segundos.</div>
        <div class="hr"></div>
        <div id="alerts"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    let lastTopId = null;

    function fmt(a){
      const parts = [];
      parts.push(`<div class="pill">ğŸš¨ ${a.occurrence || "SOS"}</div>`);
      if(a.driver_name) parts.push(`<div class="pill">ğŸ‘¤ ${a.driver_name}</div>`);
      if(a.lat && a.lng) parts.push(`<div class="pill">ğŸ“ ${Number(a.lat).toFixed(6)}, ${Number(a.lng).toFixed(6)}</div>`);
      if(a.accuracy) parts.push(`<div class="pill">Â±${Math.round(a.accuracy)}m</div>`);
      return `<div class="card" style="margin:10px 0">
        <div class="kv">${parts.join("")}</div>
        <div class="small" style="margin-top:10px">â± ${a.created_at}</div>
      </div>`;
    }

    async function refresh(){
      try{
        const j = await jget("/api/alerts");
        const arr = j.alerts || [];
        const box = document.getElementById("alerts");
        if(arr.length===0){
          box.innerHTML = `<div class="small">Nenhum alerta ainda.</div>`;
          lastTopId = null;
          return;
        }
        box.innerHTML = arr.map(fmt).join("");
        const topId = arr[0].id;
        if(lastTopId && topId !== lastTopId){
          playSirene();
          toast("ğŸš¨ Novo alerta!");
        }
        if(!lastTopId) lastTopId = topId;
        else lastTopId = topId;
      }catch(e){
        // ignore occasional failures
      }
    }

    function playSirene(){
      const a = document.getElementById("sireneAudio");
      a.currentTime = 0;
      a.play().catch(()=>{});
    }

    async function clearAlerts(){
      try{
        await jpost("/api/alerts/clear", {});
        toast("Alertas limpos");
        lastTopId = null;
        refresh();
      }catch(e){
        toast("Falha ao limpar");
      }
    }

    refresh();
    setInterval(refresh, 3000);
  </script>
</body>
</html>
