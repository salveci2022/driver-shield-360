<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel ‚Äì Pessoa de Confian√ßa | Driver Shield 360</title>
  <style>
    :root{
      --bg1:#061014; --bg2:#0b2430;
      --card:rgba(18,33,41,.78);
      --text:#eaffff; --muted:#b7c9d3;
      --ok:#35f0b8; --warn:#ffce3a; --bad:#ff4d67;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(53,240,184,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 30%, rgba(93,188,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex; align-items:center; justify-content:center; padding:22px;
    }
    .wrap{width:min(980px, 100%);}
    .top{display:flex; align-items:center; gap:14px; margin-bottom:14px}
    .logo{width:42px;height:42px;border-radius:14px;background:rgba(255,255,255,.06);display:grid;place-items:center;
          border:1px solid rgba(255,255,255,.10); box-shadow: var(--shadow)}
    .ttl{line-height:1.1}
    .ttl h1{margin:0;font-size:22px}
    .ttl p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .card{
      background:var(--card); border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
      backdrop-filter: blur(10px);
    }
    .grid{display:grid; gap:12px; grid-template-columns: 1.2fr .8fr;}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    .pill{font-size:12px; color:var(--muted); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20)}
    .pill b{color:var(--text)}
    .alertBox{
      border-radius:16px; border:1px solid rgba(255,255,255,.10); padding:14px;
      background:rgba(0,0,0,.20);
      min-height:150px;
    }
    .alertTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10)}
    .badge.ok{background:rgba(53,240,184,.10); color:var(--ok)}
    .badge.bad{background:rgba(255,77,103,.10); color:var(--bad)}
    .row{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:13px}
    .row span{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px}
    .big{font-size:18px; font-weight:800; margin:10px 0 0}
    .muted{color:var(--muted); font-size:13px; margin-top:6px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
      border:0; cursor:pointer; padding:12px 14px; border-radius:14px; font-weight:800;
      background:rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.12);
    }
    button:hover{filter:brightness(1.06)}
    .danger{background:rgba(255,77,103,.12); border-color:rgba(255,77,103,.25)}
    .primary{background:linear-gradient(90deg, rgba(53,240,184,.18), rgba(93,188,255,.18));}
    .small{font-size:12px;font-weight:700;padding:10px 12px;border-radius:12px}
    .list{
      margin:0; padding-left:18px; color:var(--muted); font-size:13px
    }
    a{color:#66d6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">üõ°Ô∏è</div>
      <div class="ttl">
        <h1>Painel ‚Äì Pessoa de Confian√ßa</h1>
        <p>Fica sempre aberto (sem senha) para resposta r√°pida. Se houver risco real, ligue <b>190</b>.</p>
      </div>
    </div>

    <div class="card">
      <div class="pillrow">
        <div class="pill">Status: <b id="status">conectando‚Ä¶</b></div>
        <div class="pill">√öltima atualiza√ß√£o: <b id="lastPoll">‚Äî</b></div>
        <div class="pill">Siren: <b id="sirenState">OFF</b></div>
      </div>

      <div class="grid">
        <div class="alertBox">
          <div class="alertTitle">
            <div><b>√öltimo alerta</b></div>
            <div class="badge ok" id="badge">aguardando</div>
          </div>

          <div class="big" id="who">Nenhum alerta ainda.</div>
          <div class="muted" id="what">Quando o motorista acionar o bot√£o, aparece aqui automaticamente.</div>

          <div class="row" style="margin-top:10px">
            <span id="when">‚è± ‚Äî</span>
            <span id="where">üìç ‚Äî</span>
          </div>

          <div class="muted" style="margin-top:10px">
            Dica: mantenha este painel aberto em segundo plano. O √°udio depende do navegador permitir som.
          </div>
        </div>

        <div>
          <div class="alertBox" style="min-height:auto">
            <b>A√ß√µes r√°pidas</b>
            <ul class="list" style="margin-top:10px">
              <li><b>Reenviar</b>: atualiza e toca a sirene novamente (se houver alerta).</li>
              <li><b>Limpar</b>: limpa o painel (e limpa alertas no servidor, se dispon√≠vel).</li>
              <li><b>Sair</b>: fecha/retorna ao painel.</li>
            </ul>

            <div class="btns" style="margin-top:12px">
              <button class="primary" id="btnReenviar">üîÅ Reenviar</button>
              <button class="danger" id="btnLimpar">üßπ Limpar</button>
              <button class="small" id="btnSair">‚Ü© Sair</button>
            </div>

            <div class="muted" style="margin-top:10px">
              Sem internet ou celular desligado: o alerta pode n√£o chegar. Este sistema √© apoio tecnol√≥gico.
              <a href="/termos" target="_blank" rel="noopener">Ver Termos</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- WebAudio Siren (no external files) ---
  let audioCtx = null;
  let oscA = null, oscB = null, gain = null;
  let sirenTimer = null;
  let sirenOn = false;

  function setSirenLabel(){
    document.getElementById('sirenState').textContent = sirenOn ? "ON" : "OFF";
  }

  function sirenStart(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume();

      if(oscA) return; // already running

      gain = audioCtx.createGain();
      gain.gain.value = 0.001;
      gain.connect(audioCtx.destination);

      oscA = audioCtx.createOscillator();
      oscB = audioCtx.createOscillator();
      oscA.type = "sine";
      oscB.type = "square";
      oscA.frequency.value = 880;
      oscB.frequency.value = 440;
      oscA.connect(gain);
      oscB.connect(gain);
      oscA.start();
      oscB.start();

      sirenOn = true;
      setSirenLabel();

      // sweep up/down
      let up = true;
      sirenTimer = setInterval(() => {
        const a = oscA.frequency.value;
        const b = oscB.frequency.value;
        const stepA = 40;
        const stepB = 20;
        if(up){
          oscA.frequency.value = Math.min(1400, a + stepA);
          oscB.frequency.value = Math.min(900, b + stepB);
          if(oscA.frequency.value >= 1400) up = false;
        }else{
          oscA.frequency.value = Math.max(700, a - stepA);
          oscB.frequency.value = Math.max(350, b - stepB);
          if(oscA.frequency.value <= 700) up = true;
        }
        // pulse volume
        gain.gain.value = 0.05;
        setTimeout(()=>{ if(gain) gain.gain.value = 0.001; }, 120);
      }, 220);

    }catch(e){
      console.log("Siren error:", e);
    }
  }

  function sirenStop(){
    if(sirenTimer){ clearInterval(sirenTimer); sirenTimer = null; }
    if(oscA){ try{ oscA.stop(); }catch(e){} oscA.disconnect(); oscA = null; }
    if(oscB){ try{ oscB.stop(); }catch(e){} oscB.disconnect(); oscB = null; }
    if(gain){ try{ gain.disconnect(); }catch(e){} gain = null; }
    sirenOn = false;
    setSirenLabel();
  }

  // --- UI helpers ---
  const statusEl = document.getElementById("status");
  const lastPollEl = document.getElementById("lastPoll");
  const badgeEl = document.getElementById("badge");

  const whoEl = document.getElementById("who");
  const whatEl = document.getElementById("what");
  const whenEl = document.getElementById("when");
  const whereEl = document.getElementById("where");

  let lastTs = null;

  function fmtLocal(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("pt-BR");
    }catch(e){ return iso; }
  }

  function setAlert(a){
    whoEl.textContent = (a.driver_name || "Motorista") + " ‚Äì " + (a.occurrence || "Ocorr√™ncia");
    whatEl.textContent = "Alerta recebido. Responda r√°pido e, em risco real, ligue 190.";
    whenEl.textContent = "‚è± " + (a.ts ? fmtLocal(a.ts) : "‚Äî");
    const hasLoc = (a.lat != null && a.lng != null && a.lat !== "" && a.lng !== "");
    whereEl.textContent = hasLoc ? `üìç ${a.lat}, ${a.lng}` : "üìç localiza√ß√£o n√£o dispon√≠vel";

    badgeEl.className = "badge bad";
    badgeEl.textContent = "ALERTA";
  }

  function clearAlertUI(){
    whoEl.textContent = "Nenhum alerta ainda.";
    whatEl.textContent = "Quando o motorista acionar o bot√£o, aparece aqui automaticamente.";
    whenEl.textContent = "‚è± ‚Äî";
    whereEl.textContent = "üìç ‚Äî";
    badgeEl.className = "badge ok";
    badgeEl.textContent = "aguardando";
    lastTs = null;
    sirenStop();
  }

  async function poll(){
    try{
      statusEl.textContent = "online";
      const r = await fetch("/api/alerts", {cache:"no-store"});
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j = await r.json();
      const arr = j.alerts || [];
      if(arr.length){
        const a = arr[0]; // newest first
        if(!lastTs || (a.ts && a.ts !== lastTs)){
          lastTs = a.ts || lastTs;
          setAlert(a);
          // autoplay policy: siren will work if user interacted once;
          // we also attempt anyway.
          sirenStart();
        }
      }
      lastPollEl.textContent = new Date().toLocaleTimeString("pt-BR");
    }catch(e){
      statusEl.textContent = "offline";
      lastPollEl.textContent = new Date().toLocaleTimeString("pt-BR");
      // do not stop siren automatically
    }
  }

  // Buttons
  document.getElementById("btnReenviar").addEventListener("click", async () => {
    await poll();
    // always play siren again if there's an alert
    if(lastTs) sirenStart();
  });

  document.getElementById("btnLimpar").addEventListener("click", async () => {
    // try server clear, then UI
    try{
      await fetch("/api/clear_alerts", {method:"POST"});
    }catch(e){}
    clearAlertUI();
  });

  document.getElementById("btnSair").addEventListener("click", () => {
    // keep it simple: go back to /painel (self) to avoid other pages
    window.location.href = "/painel";
  });

  // First interaction enables audio on mobile browsers:
  window.addEventListener("pointerdown", () => {
    if(audioCtx && audioCtx.state === "suspended") audioCtx.resume();
  }, {once:true});

  // Start polling
  poll();
  setInterval(poll, 2000);
})();
</script>
</body>
</html>
