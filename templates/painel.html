
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Painel da Pessoa de Confiança - Driver Shield 360</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<link rel="icon" href="/static/favicon.ico">
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#00ff88">
</head>
<body class="tela-escura">
  <header class="topo">
    <h1>Central de Confiança</h1>
    <p class="subtitulo">Olá, {{ usuario.nome or usuario["nome"] }}. Abaixo você vê os alertas mais recentes.</p>
  </header>

  <main class="container">
    <div class="acoes-painel">
      <form method="post" action="{{ url_for('api_limpar_alertas') }}" onsubmit="return false;" id="form-limpar-alertas">
        <button type="submit" class="btn btn-secundario">Limpar alertas</button>
      </form>
      <a href="{{ url_for('relatorio') }}" class="btn btn-secundario">Relatório completo</a>
      <a href="{{ url_for('logout') }}" class="btn btn-perigo">Sair</a>
    </div>

    <section class="lista-alertas">
      <h2>Alertas recebidos</h2>
      <table id="tabela-alertas">
        <thead>
          <tr>
            <th>#</th>
            <th>Data/Hora (Brasília)</th>
            <th>Motorista</th>
            <th>Ocorrência</th>
            <th>Localização</th>
          </tr>
        </thead>
        <tbody>
          {% for a in alertas %}
          <tr>
            <td>{{ a.id or a["id"] }}</td>
            <td>{{ a.timestamp_brt or a["timestamp_brt"] }}</td>
            <td>{{ a.motorista or a["motorista"] }}</td>
            <td>{{ a.ocorrencia or a["ocorrencia"] }}</td>
            <td>
              {% if a.latitude and a.longitude %}
                <a href="https://www.google.com/maps?q={{ a.latitude }},{{ a.longitude }}" target="_blank">
                  Ver no mapa ({{ a.latitude }}, {{ a.longitude }})
                </a>
              {% else %}
                Sem localização
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </main>

  <script>
    document.getElementById('form-limpar-alertas').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!confirm('Tem certeza que deseja limpar todos os alertas?')) return;

      const resp = await fetch('{{ url_for("api_limpar_alertas") }}', {
        method: 'POST'
      });
      const data = await resp.json();
      if (data.status === 'ok') {
        document.querySelector('#tabela-alertas tbody').innerHTML = '';
        alert('Alertas limpos com sucesso.');
      }
    });
  
// Fullscreen
(function(){
  const btn=document.getElementById('btnFull');
  if(btn){
    btn.addEventListener('click', ()=>{
      const el=document.documentElement;
      if(!document.fullscreenElement){
        (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);
      }else{
        (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document);
      }
    });
  }
})();

// Ações
const sirene = document.getElementById('sirene');
const btnSair = document.getElementById('btnSair');
const btnReiniciar = document.getElementById('btnReiniciar');
const btnLimparTudo = document.getElementById('btnLimparTudo');

if(btnSair){ btnSair.addEventListener('click', ()=>{ window.location.href='/painel_saida'; }); }
if(btnReiniciar){ btnReiniciar.addEventListener('click', ()=>{ window.location.reload(); }); }
if(btnLimparTudo){
  btnLimparTudo.addEventListener('click', async ()=>{
    try{
      await fetch('/api/limpar_alertas', {method:'POST'});
    }catch(e){}
    try{ sirene.pause(); sirene.currentTime=0; }catch(e){}
    window.location.reload();
  });
}

// Tocar sirene quando chegar alerta novo
let lastCount = 0;
async function checkAlerts(){
  try{
    const r = await fetch('/api/alertas');
    const data = await r.json();
    const count = (data && data.alertas) ? data.alertas.length : 0;
    if(count > lastCount){
      try{ await sirene.play(); }catch(e){}
    }
    lastCount = count;
  }catch(e){}
}
setInterval(checkAlerts, 2500);
checkAlerts();
</script>
</body>
</html>
