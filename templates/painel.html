<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel â€” Driver Shield 360</title>

  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/driver_shield_360.png">
</head>

<body>
<div class="container">

  <div class="header">
    <div class="brand">
      <div class="logo">
        <img src="/static/driver_shield_360.png" alt="Logo">
      </div>
      <div>
        <h1 class="h1">Painel da Pessoa de ConfianÃ§a</h1>
        <div class="subtitle">
          Alertas aparecem somente quando o motorista aciona o botÃ£o.
        </div>
      </div>
    </div>
  </div>

  <div class="card">

    <!-- ðŸ”Š CONTROLE DE SOM -->
    <div class="btnbar">
      <button id="enableSound" class="btn btn-secondary">
        ðŸ”Š Ativar Sirene
      </button>

      <button onclick="stopSiren()" class="btn btn-danger">
        â›” Parar Sirene
      </button>
    </div>

    <div id="soundStatus" class="small" style="margin-bottom:10px;">
      Som: <b>desativado</b>
    </div>

    <div class="hr"></div>

    <!-- TABELA DE ALERTAS -->
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Motorista</th>
          <th>OcorrÃªncia</th>
          <th>LocalizaÃ§Ã£o</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4">Carregandoâ€¦</td></tr>
      </tbody>
    </table>

    <div class="small">AtualizaÃ§Ã£o automÃ¡tica a cada 5 segundos.</div>

  </div>
</div>

<!-- ðŸ”Š SIRENE -->
<audio id="siren" preload="auto" loop>
  <source src="/static/sirene.mp3" type="audio/mpeg">
</audio>

<script>
const siren = document.getElementById("siren");
const enableBtn = document.getElementById("enableSound");
const soundStatus = document.getElementById("soundStatus");

let soundEnabled = localStorage.getItem("ds360_sound") === "1";
let sirenPlaying = false;
let lastAlertId = null;

function setSoundStatus(){
  soundStatus.innerHTML =
    "Som: <b>" + (soundEnabled ? "ativado âœ…" : "desativado") + "</b>";
}

async function enableSound(){
  try{
    await siren.play();
    siren.pause();
    siren.currentTime = 0;
    soundEnabled = true;
    localStorage.setItem("ds360_sound", "1");
    enableBtn.innerText = "ðŸ”Š Sirene habilitada";
    enableBtn.disabled = true;
    setSoundStatus();
  }catch(e){
    alert("Toque novamente em 'Ativar Sirene' para liberar o Ã¡udio.");
  }
}

function startSiren(){
  if(!soundEnabled || sirenPlaying) return;
  sirenPlaying = true;
  siren.play().catch(()=>{});
}

function stopSiren(){
  siren.pause();
  siren.currentTime = 0;
  sirenPlaying = false;
}

enableBtn.addEventListener("click", enableSound);
setSoundStatus();

/* ====== ALERTAS ====== */

function fmtLoc(a){
  if(!a || !a.location) return "â€”";
  const {lat,lon,acc} = a.location;
  return lat.toFixed(5)+", "+lon.toFixed(5)+" (Â±"+Math.round(acc||0)+"m)";
}

async function loadAlerts(){
  const body = document.getElementById("tbody");
  try{
    const r = await fetch("/api/alerts");
    const data = await r.json();

    if(!data.alerts || !data.alerts.length){
      body.innerHTML = '<tr><td colspan="4">Nenhum alerta.</td></tr>';
      return;
    }

    const newest = data.alerts[0];
    if(lastAlertId !== newest.id){
      lastAlertId = newest.id;
      startSiren(); // ðŸ”´ TOCA A SIRENE NO ALERTA NOVO
    }

    body.innerHTML = "";
    data.alerts.slice(0,10).forEach(a=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.ts_human || a.ts}</td>
        <td>${a.driver_name || "â€”"}</td>
        <td>${a.occurrence || "â€”"}</td>
        <td>${fmtLoc(a)}</td>
      `;
      body.appendChild(tr);
    });

  }catch(e){
    body.innerHTML = '<tr><td colspan="4">Erro ao carregar.</td></tr>';
  }
}

loadAlerts();
setInterval(loadAlerts, 5000);
</script>

</body>
</html>
