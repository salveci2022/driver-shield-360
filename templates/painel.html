
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel da Pessoa de Confian√ßa - Driver Shield 360</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="tela-escura">
  <header class="topo">
    <h1>Central de Confian√ßa</h1>
    <p class="subtitulo">Ol√°, {{ usuario.nome or usuario["nome"] }}. Abaixo voc√™ v√™ os alertas mais recentes.</p>
  </header>
  <audio id="sireneAudio" preload="auto" loop>
    <source src="{{ url_for('static', filename='sirene.wav') }}" type="audio/wav">
  </audio>


  <main class="container">
    <div class="acoes-painel">
      <button type="button" class="btn btn-secundario" onclick="doFullscreen()">‚õ∂ Tela cheia</button>
      <button type="button" class="btn btn-secundario" onclick="doReiniciar()">Reiniciar</button>
      <button type="button" class="btn btn-perigo" onclick="toggleSirene()">üîä Sirene</button>

      <form method="post" action="{{ url_for('api_limpar_alertas') }}" onsubmit="return false;" id="form-limpar-alertas">
        <button type="submit" class="btn btn-secundario">Limpar alertas</button>
      </form>

      <a href="{{ url_for('relatorio') }}" class="btn btn-secundario">Relat√≥rio completo</a>

      {% set aberto = (modo_aberto | default(false)) %}
      {% if aberto %}
        <a href="{{ url_for('index') }}" class="btn btn-perigo">Sair</a>
      {% else %}
        <a href="{{ url_for('logout') }}" class="btn btn-perigo">Sair</a>
      {% endif %}
    </div>

    <section class="lista-alertas">
      <h2>Alertas recebidos</h2>
      <table id="tabela-alertas">
        <thead>
          <tr>
            <th>#</th>
            <th>Data/Hora (Bras√≠lia)</th>
            <th>Motorista</th>
            <th>Ocorr√™ncia</th>
            <th>Localiza√ß√£o</th>
          </tr>
        </thead>
        <tbody>
          {% for a in alertas %}
          <tr>
            <td>{{ a.id or a["id"] }}</td>
            <td>{{ a.timestamp_brt or a["timestamp_brt"] }}</td>
            <td>{{ a.motorista or a["motorista"] }}</td>
            <td>{{ a.ocorrencia or a["ocorrencia"] }}</td>
            <td>
              {% if a.latitude and a.longitude %}
                <a href="https://www.google.com/maps?q={{ a.latitude }},{{ a.longitude }}" target="_blank">
                  Ver no mapa ({{ a.latitude }}, {{ a.longitude }})
                </a>
              {% else %}
                Sem localiza√ß√£o
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // ===== Tela cheia =====
    function doFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
    }

    function doReiniciar() {
      window.location.reload(true);
    }

    // ===== Sirene =====
    let sireneOn = false;
    let audioLiberado = false;
    const audio = document.getElementById('sireneAudio');

    // Chrome no celular √†s vezes bloqueia autoplay; liberamos ap√≥s 1 toque
    window.addEventListener('pointerdown', () => {
      audioLiberado = true;
    }, { once: true });

    function tocarSirene() {
      if (!audio) return;
      if (!audioLiberado) return; // precisa intera√ß√£o do usu√°rio
      audio.volume = 1.0;
      audio.play().then(() => { sireneOn = true; }).catch(() => {});
    }

    function pararSirene() {
      if (!audio) return;
      audio.pause();
      audio.currentTime = 0;
      sireneOn = false;
    }

    function toggleSirene() {
      if (sireneOn) pararSirene();
      else tocarSirene();
    }

    // ===== Limpar alertas =====
    document.getElementById('form-limpar-alertas').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!confirm('Tem certeza que deseja limpar todos os alertas?')) return;

      const resp = await fetch('{{ url_for("api_limpar_alertas") }}', { method: 'POST' });
      const data = await resp.json();
      if (data.status === 'ok') {
        document.querySelector('#tabela-alertas tbody').innerHTML = '';
        alert('Alertas limpos com sucesso.');
      }
    });

    // ===== Atualiza√ß√£o em tempo real + toca sirene ao chegar alerta novo =====
    let ultimoId = null;

    function montarLinha(a) {
      const id = a.id ?? a["id"];
      const ts = a.timestamp_brt ?? a["timestamp_brt"] ?? "";
      const motorista = a.motorista ?? a["motorista"] ?? "";
      const ocorr = a.ocorrencia ?? a["ocorrencia"] ?? "";
      const lat = a.latitude ?? a["latitude"];
      const lng = a.longitude ?? a["longitude"];

      let locHtml = "Sem localiza√ß√£o";
      if (lat && lng) {
        const url = `https://www.google.com/maps?q=${lat},${lng}`;
        locHtml = `<a href="${url}" target="_blank">Ver no mapa (${lat}, ${lng})</a>`;
      }
      return `<tr>
        <td>${id}</td>
        <td>${ts}</td>
        <td>${motorista}</td>
        <td>${ocorr}</td>
        <td>${locHtml}</td>
      </tr>`;
    }

    async function atualizarAlertas() {
      try {
        const resp = await fetch('{{ url_for("api_alertas") }}', { cache: 'no-store' });
        const alertas = await resp.json();

        // ordena do mais recente pro mais antigo
        alertas.sort((a,b) => (b.id ?? b["id"] ?? 0) - (a.id ?? a["id"] ?? 0));

        const tbody = document.querySelector('#tabela-alertas tbody');
        tbody.innerHTML = alertas.map(montarLinha).join("");

        const topo = alertas[0];
        const topoId = topo ? (topo.id ?? topo["id"]) : null;

        if (ultimoId !== null && topoId !== null && topoId !== ultimoId) {
          // alerta novo chegou
          tocarSirene();
        }
        ultimoId = topoId;
      } catch (e) {
        // silencioso
      }
    }

    // primeira carga e polling
    atualizarAlertas();
    setInterval(atualizarAlertas, 3000);
  </script>
</body>
</html>
