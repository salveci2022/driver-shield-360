<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel ‚Äî Pessoa de Confian√ßa</title>
  <link rel="stylesheet" href="/static/style.css?v=12">
  <link rel="icon" href="/static/icon-192.png">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"><img src="/static/icon-192.png" alt="Logo"></div>
      <div>
        <h1 class="h1">Painel da Pessoa de Confian√ßa</h1>
        <div class="subtitle">Sem acesso aos outros pain√©is ‚Ä¢ foco em resposta r√°pida.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="badges">
      <span class="badge">üîä Sirene (1 toque)</span>
      <span class="badge">üìç Localiza√ß√£o no alerta</span>
      <span class="badge">‚ö†Ô∏è N√£o substitui 190</span>
    </div>

    <div class="field">
      <label>PIN (4‚Äì6 n√∫meros)</label>
      <input id="pinConf" inputmode="numeric" maxlength="6" placeholder="Digite o PIN cadastrado">
      <div class="small">Sem telefone. Sem e-mail. PIN apenas para acesso r√°pido.</div>
    </div>

    <div class="btnbar">
      <button class="btn btn-secondary" id="entrar">Acessar painel</button>
      <button class="btn btn-secondary" id="enableSound" disabled>üîä Ativar Sirene</button>
      <button class="btn btn-danger" id="stopSound" disabled>‚õî Parar Sirene</button>
    </div>

    <div class="small" id="soundStatus" style="margin-top:10px">Som: <b>desativado</b></div>

    <div class="hr"></div>

    <table class="table">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Motorista</th>
          <th>Ocorr√™ncia</th>
          <th>Localiza√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4">Digite o PIN para visualizar alertas.</td></tr>
      </tbody>
    </table>

    <div class="small" style="margin-top:10px">Em risco real, ligue imediatamente <b>190</b>. Este painel √© apoio de comunica√ß√£o.</div>
  </div>
</div>

<audio id="siren" preload="auto" loop>
  <source src="/static/sirene.wav" type="audio/wav">
</audio>

<script>
  // Bloqueia links internos (se algu√©m inserir por engano)
  document.addEventListener("click", (e)=>{
    const a = e.target.closest("a");
    if(!a) return;
    const href = (a.getAttribute("href") || "").trim();
    const allowed = href === "/termos" || href.startsWith("tel:") || href.startsWith("http");
    if(!allowed){ e.preventDefault(); alert("Acesso restrito: este painel √© apenas para alertas."); }
  });

  const siren = document.getElementById("siren");
  const enableBtn = document.getElementById("enableSound");
  const stopBtn = document.getElementById("stopSound");
  const statusEl = document.getElementById("soundStatus");

  let soundEnabled = localStorage.getItem("ds360_sound") === "1";
  let sirenPlaying = false;
  let lastAlertId = null;
  let sessionToken = null;

  function setStatus(){
    statusEl.innerHTML = "Som: <b>" + (soundEnabled ? "ativado ‚úÖ" : "desativado") + "</b>";
  }
  setStatus();

  async function enableSoundOnce(){
    try{
      await siren.play();
      siren.pause();
      siren.currentTime = 0;
      soundEnabled = true;
      localStorage.setItem("ds360_sound", "1");
      enableBtn.textContent = "üîä Sirene habilitada";
      enableBtn.disabled = true;
      setStatus();
    }catch(e){
      alert("Toque novamente em 'Ativar Sirene' para liberar o √°udio.");
    }
  }

  function startSiren(){
    if(!soundEnabled || sirenPlaying) return;
    sirenPlaying = true;
    siren.play().catch(()=>{});
  }
  function stopSiren(){
    siren.pause();
    siren.currentTime = 0;
    sirenPlaying = false;
  }

  enableBtn.addEventListener("click", enableSoundOnce);
  stopBtn.addEventListener("click", stopSiren);

  function fmtLoc(a){
    if(!a.location) return "‚Äî";
    const {lat, lon, acc} = a.location;
    const maps = `https://www.google.com/maps?q=${lat},${lon}`;
    const accTxt = acc ? ` (¬±${Math.round(acc)}m)` : "";
    return `<a href="${maps}" target="_blank">${lat.toFixed(5)}, ${lon.toFixed(5)}</a>${accTxt}`;
  }

  async function doLogin(){
    const pin = document.getElementById("pinConf").value.trim();
    if(!/^[0-9]{4,6}$/.test(pin)){ alert("PIN inv√°lido. Use 4 a 6 n√∫meros."); return; }

    const r = await fetch("/api/trust/login", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({pin})
    });
    const data = await r.json().catch(()=>({}));
    if(!r.ok || !data.token){
      alert("PIN incorreto ou n√£o cadastrado.");
      return;
    }
    sessionToken = data.token;
    document.getElementById("entrar").disabled = true;
    document.getElementById("pinConf").disabled = true;
    enableBtn.disabled = false;
    stopBtn.disabled = false;
    loadAlerts();
    setInterval(loadAlerts, 5000);
  }

  async function loadAlerts(){
    if(!sessionToken) return;
    const r = await fetch("/api/alerts", { headers: {"X-Trust-Token": sessionToken} });
    const data = await r.json().catch(()=>({alerts:[] }));
    const tb = document.getElementById("tbody");

    if(!data.alerts || !data.alerts.length){
      tb.innerHTML = '<tr><td colspan="4">Nenhum alerta.</td></tr>';
      return;
    }
    const newest = data.alerts[0];
    if(lastAlertId !== newest.id){
      lastAlertId = newest.id;
      startSiren();
    }
    tb.innerHTML = data.alerts.slice(0,20).map(a => `
      <tr>
        <td>${a.ts_human}</td>
        <td>${a.driver_name || "‚Äî"}</td>
        <td>${a.occurrence || "‚Äî"}</td>
        <td>${fmtLoc(a)}</td>
      </tr>
    `).join("");
  }

  document.getElementById("entrar").addEventListener("click", doLogin);
</script>
</body>
</html>
