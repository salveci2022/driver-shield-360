<!doctype html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" type="image/png" href="/static/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#0a0014">
  <meta charset="utf-8">
  <title>RelatÃ³rio - Driver Shield 360</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">ğŸ“Š RelatÃ³rio de OcorrÃªncias</div>
        <div class="row">
          <button class="btn small" onclick="goFull()">â›¶ Tela cheia</button>
          <button class="btn small" onclick="location.reload()">ğŸ”„ Atualizar</button>
          <button class="btn small" onclick="copiar()">ğŸ“‹ Copiar</button>
          <button class="btn small danger" onclick="limpar()">ğŸ§¹ Limpar</button>
          <a class="btn small" href="/">Sair</a>
        </div>
      </div>

      {% if alerts and alerts|length > 0 %}
      <table class="table" id="tabela">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Motorista</th>
            <th>OcorrÃªncia</th>
            <th>LocalizaÃ§Ã£o</th>
          </tr>
        </thead>
        <tbody>
          {% for a in alerts %}
          <tr>
            <td><b>{{ a.ts }}</b></td>
            <td>{{ a.motorista }}</td>
            <td>{{ a.ocorrencia }}</td>
            <td>
              {% if a.lat and a.lng %}
                <div>Lat: {{ a.lat }}<br>Lng: {{ a.lng }}</div>
                <div style="margin-top:6px">
                  <a class="btn small" target="_blank" href="https://www.google.com/maps?q={{ a.lat }},{{ a.lng }}&z=16">
                    ğŸ—ºï¸ Abrir mapa
                  </a>
                </div>
              {% else %}
                â€”
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="notice">Nenhuma ocorrÃªncia registrada.</div>
      {% endif %}
    </div>
  </div>

  <script>
    function goFull(){
      const el=document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen();
    }

    async function limpar(){
      if(!confirm('Limpar todos os alertas? Essa aÃ§Ã£o nÃ£o pode ser desfeita.')) return;

      try{
        const res = await fetch('/api/clear_alerts', { method:'POST' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const j = await res.json();

        if(j.ok){
          alert('âœ… Alertas limpos!');
          location.reload();
        }else{
          alert('âŒ Falha ao limpar. Tente novamente.');
        }
      }catch(e){
        alert('âŒ Erro ao comunicar com o servidor (Render).');
      }
    }

    async function copiar(){
      const table = document.getElementById('tabela');
      if(!table){
        alert('Nada para copiar.');
        return;
      }

      let texto = 'RELATÃ“RIO DRIVER SHIELD 360\n\n';
      const rows = table.querySelectorAll('tbody tr');

      rows.forEach((tr, i) => {
        const cols = tr.querySelectorAll('td');
        const data = cols[0]?.innerText.trim() || '';
        const motorista = cols[1]?.innerText.trim() || '';
        const ocorr = cols[2]?.innerText.trim() || '';
        const loc = cols[3]?.innerText.trim().replace(/\s+/g,' ') || 'â€”';

        texto += `#${i+1}\nğŸ•’ ${data}\nğŸš• ${motorista}\nâš ï¸ ${ocorr}\nğŸ“ ${loc}\n\n`;
      });

      try{
        await navigator.clipboard.writeText(texto);
        alert('âœ… Copiado! Agora Ã© sÃ³ colar no WhatsApp.');
      }catch(e){
        alert('âŒ NÃ£o consegui copiar automaticamente. Seu navegador bloqueou.');
      }
    }
  </script>
</body>
</html>
